<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>An Introduction to Quantitative Text Analysis for Linguistics - 9&nbsp; Predict</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./inference.html" rel="next">
<link href="./exploration.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://hypothes.is/embed.js"></script><script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="assets/css/mini.css">
</head>
<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./analysis.html">Analysis</a></li><li class="breadcrumb-item"><a href="./prediction.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Predict</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">An Introduction to Quantitative Text Analysis for Linguistics</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/qtalr/book" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./qtalr-manuscript.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./orientation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Orientation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./text-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Text analysis</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./foundations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./understanding-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./approaching-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./framing-research.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Research</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./preparation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preparation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./acquire-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Acquire</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./curate-datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Curate</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transform-datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Transform</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./exploration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Explore</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./prediction.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Predict</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Infer</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./communication.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Communication</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./contributing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Contribute</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Data</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#sec-pda-orientation" id="toc-sec-pda-orientation" class="nav-link active" data-scroll-target="#sec-pda-orientation"><span class="header-section-number">9.1</span> Orientation</a>
  <ul class="collapse">
<li><a href="#sec-pda-goals-approach" id="toc-sec-pda-goals-approach" class="nav-link" data-scroll-target="#sec-pda-goals-approach"><span class="header-section-number">9.1.1</span> Goals and approach</a></li>
  </ul>
</li>
  <li>
<a href="#sec-pda-analysis" id="toc-sec-pda-analysis" class="nav-link" data-scroll-target="#sec-pda-analysis"><span class="header-section-number">9.2</span> Analysis</a>
  <ul class="collapse">
<li><a href="#sec-pda-text-classification" id="toc-sec-pda-text-classification" class="nav-link" data-scroll-target="#sec-pda-text-classification"><span class="header-section-number">9.2.1</span> Text classification</a></li>
  <li><a href="#sec-pda-text-regression" id="toc-sec-pda-text-regression" class="nav-link" data-scroll-target="#sec-pda-text-regression"><span class="header-section-number">9.2.2</span> Text regression</a></li>
  </ul>
</li>
  <li><a href="#activities" id="toc-activities" class="nav-link" data-scroll-target="#activities">Activities</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/qtalr/book/blob/main/prediction.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/qtalr/book/edit/main/prediction.qmd" target="_blank" class="toc-action"><i class="bi empty"></i>Edit this page</a></li><li><a href="https://github.com/qtalr/book/issues" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./analysis.html">Analysis</a></li><li class="breadcrumb-item"><a href="./prediction.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Predict</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-prediction" class="quarto-section-identifier"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Predict</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><!--

Content:

- [x] Note on hypothesis testing?
  - Confidence intervals?
  - MuPDAR approach (Multifactorial Prediction and Deviation Analysis with Regressions) [@Deshors2016; @Gries2014] and @Baayen2011
    - Training on group
    - Testing on another group (or groups)

- [ ] Make sure to standardize the use of 'variable' and 'feature'.
- [ ] Update/ simplify the variable names so they are shorter and more consistent.
- [ ] IMPORTANT: I'm not liking the flow of application. It seems that I should introduce the notion of cross-validation earlier and avoid fitting the training set with `fit()` and then using `predict()`.

Exercises:

- [ ] add concept questions to Activities
- [ ] add exercises to Activities
- [ ] add thought questions/ case studies to prose sections

Formatting:

- [ ] add citations
  - [ ] for study rationale
  - [ ] for packages

--><blockquote class="blockquote">
<p>All models are wrong, but some are useful.</p>
<p>— George E.P. Box</p>
</blockquote>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong><i class="fa-regular fa-list-alt" aria-label="list-alt"></i> Outcomes</strong></p>
<ul>
<li>Identify the research goals of predictive data analysis</li>
<li>Describe the workflow for predictive data analysis</li>
<li>Recognize quantitative and qualitative methods for evaluating predictive models</li>
</ul>
</div>
</div>
</div>
<p>In this chapter, I introduce supervised learning as an approach to data analysis, specifically focusing on its applications in text analysis. Supervised learning aims to establish a relationship between a target (or outcome) variable and a set of feature variables derived from text data. By leveraging this relationship, statistical generalizations (models) can be created to accurately predict values of the target variable based on the values of the feature variables. Throughout the chapter, we explore practical tasks and theoretical applications of statistical learning in text analysis.</p>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong><i class="fa-solid fa-terminal" aria-label="terminal"></i> Lessons</strong></p>
<p><strong>What</strong>: <a href="https://github.com/qtalr/lessons">Advanced Visualization</a><br><strong>How</strong>: In the R Console pane load <code>swirl</code>, run <code>swirl()</code>, and follow prompts to select the lesson.<br><strong>Why</strong>: To dive deeper into the <code>ggplot2</code> package to enhance visual summaries and provides an introduction to the <code>factoextra</code> and <code>ggfortify</code> packages that extend <code>ggplot2</code> capabilities to model objects.</p>
</div>
</div>
</div>
<section id="sec-pda-orientation" class="level2" data-number="9.1"><h2 data-number="9.1" class="anchored" data-anchor-id="sec-pda-orientation">
<span class="header-section-number">9.1</span> Orientation</h2>
<p>In this section, I introduce the concept of supervised learning and provide an overview of the workflow for building and evaluating predictive models for text analysis. We will discuss the research goals that are typically addressed using supervised learning and then estabnlish a workflow for building predictive models, including the steps for preparing data, training and testing models, and evaluating and reporting results.</p>
<section id="sec-pda-goals-approach" class="level3" data-number="9.1.1"><h3 data-number="9.1.1" class="anchored" data-anchor-id="sec-pda-goals-approach">
<span class="header-section-number">9.1.1</span> Goals and approach</h3>
<p>Predictive data analysis (PDA) is a powerful analysis method for linguists and other researchers interested in making predictions about new or future data based on patterns in existing data. As discussed in <a href="approaching-analysis.html#sec-aa-predict" class="quarto-xref"><span>Section 3.2.2</span></a> and <a href="framing-research.html#sec-fr-plan" class="quarto-xref"><span>Section 4.4.1</span></a>, PDA is a type of supervised learning, which means that it involves training a model on a labeled dataset where the input data and desired output are both provided. The model is able to make predictions or classifications based on the input data by learning the relationships between the input and output data. Supervised machine learning is an important tool for linguists studying language and communication, as it allows us to analyze language data to identify patterns or trends in language use, assess hypotheses, and prescribe actions.</p>
<p>The approach to conducting predictive analysis shares some commonalities with exploratory data analysis (<a href="exploration.html#sec-eda-goals-approach" class="quarto-xref"><span>Section 8.1.1</span></a>) (as well as inferential analysis <a href="inference.html" class="quarto-xref"><span>Chapter 10</span></a>), but there are also some key differences. Consider the workflow in <a href="#tbl-pda-workflow" class="quarto-xref">Table&nbsp;<span>9.1</span></a>.</p>
<!-- Workflow -->
<div id="tbl-pda-workflow" class="striped quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-pda-workflow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;9.1: Workflow for predictive data analysis
</figcaption><div aria-describedby="tbl-pda-workflow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table-striped table">
<colgroup>
<col style="width: 5%">
<col style="width: 10%">
<col style="width: 85%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Name</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Identify</td>
<td>Consider the research question and aim and identify relevant variables</td>
</tr>
<tr class="even">
<td>2</td>
<td></td>
<td>Split the data into representative training and testing sets</td>
</tr>
<tr class="odd">
<td>3</td>
<td></td>
<td>Apply variable selection and engineering procedures</td>
</tr>
<tr class="even">
<td>4</td>
<td>Inspect</td>
<td>Inspect the data to ensure that it is in the correct format and that the training and testing sets are representative of the data</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Interrogate</td>
<td>Train and evaluate the model on the training set, adjusting models or hyperparameters as needed, to produce a final model</td>
</tr>
<tr class="even">
<td>6</td>
<td>(Optional) Iterate</td>
<td>Repeat steps 3-5 to selecting new variables, models, hyperparameters</td>
</tr>
<tr class="odd">
<td>7</td>
<td>Interpret</td>
<td>Interpret the results of the final model in light of the research question or hypothesis</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>Focusing on the overlap with other analysis methods, we can see some fundamentals steps such as identifying relevant variables, inspecting the data, interrogating the data, and interpreting the results. And if our research aim is exploratory in nature, iteration may also be a part of the workflow. These steps highlight the importance conducting methodologic and communicable research, as discussed in <a href="framing-research.html#sec-fr-frame" class="quarto-xref"><span>Section 4.1</span></a>.</p>
<p>There are two main differences, however, between the PDA and the EDA workflow we discussed in <a href="exploration.html" class="quarto-xref"><span>Chapter 8</span></a>. The first, reflected the majority of the steps in the workflow, is that PDA requires partitioning the data into training and testing sets. As discussed in <a href="approaching-analysis.html#sec-aa-predict" class="quarto-xref"><span>Section 3.2.2</span></a>, the training set is used to develop the model, and the testing set is used to evaluate the model’s performance. This strategy is used to ensure that the model is robust and generalizes well to new data. It is well known, and makes intuitive sense, that using the same data to develop and evaluate a model likely will not produce a model that generalizes well to new data. This is because the model will have potentially conflated the nuances of the data (‘the noise’) with any real trends (‘the signal’) and therefore will not be able to generalize well to new data. This is called <strong>overfitting</strong> and by holding out a portion of the data for testing, we can evaluate the model’s performance on data that it has not seen before and therefore get a more accurate estimate of the generalizable trends in the data.</p>
<div class="halfsize callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong><i class="fa-solid fa-medal" aria-label="medal"></i> Dive deeper</strong></p>
<p>Prediction modeling is a hot topic. Given the potential to make actionable predictions about future outcomes, it attracts a lot of attention from organizations which aim to leverage data to make informed decisions. It’s use in research is also growing beyond the development of better models and using predictive models to address research questions and hypotheses.</p>
<p>We will apply predictive modeling in the context of language data as a semi-inductive method. However, it is also increasingly used in hypothesis testing scenarios, see <span class="citation" data-cites="Gries2014">Gries and Deshors (<a href="references.html#ref-Gries2014" role="doc-biblioref">2014</a>)</span>, <span class="citation" data-cites="Deshors2016">Deshors and Gries (<a href="references.html#ref-Deshors2016" role="doc-biblioref">2016</a>)</span>, and <span class="citation" data-cites="Baayen2011">Baayen (<a href="references.html#ref-Baayen2011" role="doc-biblioref">2011</a>)</span> for more information.</p>
</div>
</div>
</div>
<p>Another procedure to avoid the perils of overfitting, is to use resampling methods as part of the model evaluation on the training set. Resampling is the process of repeatedly drawing samples from the training set and evaluating the model on each sample. The two most common resampling methods are <strong>bootstrapping</strong> (resampling with replacement) and <strong>cross-validation</strong> (resampling without replacement). The performance of these multiple models are summarized and the error between them is assessed. The goal is to minimize the performance differences between the models while maximizing the overall performance. These measures go a long way to avoiding overfitting and therefore maximizing the chance that the training phase will produce a model which is robust at the testing phase.</p>
<p>The second difference, not reflected in the workflow but inherent in predictive analysis, is that PDA requires a fixed outcome variable. This means that the outcome variable must be defined from the outset and cannot be changed during the analysis. Furthermore, the informational nature of the outcome variable will dictate the what type of algorithm we choose to interrogate the data and how we will evaluate the model’s performance.</p>
<p>If the outcome is categorical in nature, we will use a <strong>classification algorithm</strong> (<em>e.g.</em> logistic regression, naive bayes, <em>etc.</em>). Classification evaluation metrics include accuracy, precision, recall, and F1 score which can be derived from and visualized in a cross-tabulation of the predicted and actual outcome values.</p>
<p>If the outcome is numeric in nature, we will use a <strong>regression algorithm</strong> (<em>e.g.</em> linear regression, support vector regression, <em>etc.</em>). Since the difference between prediction and actual values is numeric, metrics that quantify numerical differences, such as root mean square error (RMSE) or <span class="math inline">\(R^2\)</span>, are used to evaluate the model’s performance.</p>
<p>The evaluation of the model is quantitative on the one hand, but it is also qualitative in that we need to consider the implications of the model’s performance in light of the research question or hypothesis. Furthermore, depending on our research question we may be interested in exploring the features that are most important to the model’s performance. This is called <strong>feature importance</strong> and can be derived from the model’s coefficients or weights. Notably, however, some of the most powerful models in use today, such as deep neural networks, are not easily interpretable and therefore feature importance is not easily derived. This is something to keep in mind when considering the research question and the type of model that will be used to address it.</p>
</section></section><section id="sec-pda-analysis" class="level2" data-number="9.2"><h2 data-number="9.2" class="anchored" data-anchor-id="sec-pda-analysis">
<span class="header-section-number">9.2</span> Analysis</h2>
<!-- Goals of this section -->
<p>In this section we now turn to the practical application of predictive data analysis. The dicussion will be separated into classification and regression tasks, as model selection and evaluation procedures differ between the two. For each task, we will frame a research goal and work through the process of building a predictive model to address that goal. Along the way we will cover concepts and methods that are common to both classification and regression tasks and specific to each.</p>
<!-- Research questions -->
<p>To frame our analyses, we will posit research aimed at identifying language usage patterns in second language use, one for a classification task and one for a regression task. Our first research question will be to identify potential salient differences in Spanish language use between natives and L1 English learners (categorical). Our second research question will be to gauge the extent to which the the L1 English learners’ Spanish language placement test scores (numeric) can be predicted based on their language use.</p>
<p>We will use data from the CEDEL2 corpus<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. We will include a subset of the variables from this data that are relevant to our research questions. The data dictionary for this dataset is seen in <a href="#tbl-pda-cedel2-data-dictionary" class="quarto-xref">Table&nbsp;<span>9.2</span></a>.</p>
<div class="cell" data-tbl-colwidths="[15,15,15,55]">
<div id="tbl-pda-cedel2-data-dictionary" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-pda-cedel2-data-dictionary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;9.2: Data dictionary for the CEDEL2 corpus
</figcaption><div aria-describedby="tbl-pda-cedel2-data-dictionary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="cell table table-sm table-striped small">
<colgroup>
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 55%">
</colgroup>
<thead><tr class="header">
<th>variable</th>
<th>name</th>
<th>variable_type</th>
<th>description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>doc_id</td>
<td>Document ID</td>
<td>numeric</td>
<td>Unique identifier for each document</td>
</tr>
<tr class="even">
<td>subcorpus</td>
<td>Subcorpus</td>
<td>categorical</td>
<td>The subcorpus to which the document belongs (‘Learner’ or ‘Native’)</td>
</tr>
<tr class="odd">
<td>placement_score</td>
<td>Placement Score</td>
<td>numeric</td>
<td>The score obtained by the document author in a placement test. Null values indicate missing data (i.e.&nbsp;the document author did not take the placement test)</td>
</tr>
<tr class="even">
<td>proficiency</td>
<td>Proficiency</td>
<td>ordinal</td>
<td>The level of language proficiency of the document author (‘Upper intermediate’, ‘Lower advanced’, ‘Upper beginner’, or ‘Native’)</td>
</tr>
<tr class="odd">
<td>text</td>
<td>Text</td>
<td>character</td>
<td>The written text provided by the document author</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>Let’s go ahead and read the transformed dataset and preview it in <a href="#exm-pda-cedel-read" class="quarto-xref">Example&nbsp;<span>9.1</span></a>.</p>
<div id="exm-pda-cedel-read" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.1</strong></span> &nbsp;</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Read in the dataset</span></span>
<span><span class="va">cedel_tbl</span><span class="op">&lt;-</span></span>
<span>  <span class="fu">read_csv</span><span class="op">(</span><span class="st">"../data/cedel2/cedel2_transformed.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">cedel_tbl</span><span class="op">|&gt;</span> <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>&gt; Rows: 2,957
&gt; Columns: 5
&gt; $ doc_id          &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16,…
&gt; $ subcorpus       &lt;chr&gt; "Learner", "Learner", "Learner", "Learner", "Learner",…
&gt; $ placement_score &lt;dbl&gt; 14.0, 16.3, 16.3, 18.6, 18.6, 18.6, 20.9, 20.9, 20.9, …
&gt; $ proficiency     &lt;chr&gt; "Lower beginner", "Lower beginner", "Lower beginner", …
&gt; $ text            &lt;chr&gt; "Yo vivo es Alanta, Georgia. Atlanta es muy grande ciu…</code></pre>
</div>
</div>
</div>
<p>The output of <a href="#exm-pda-cedel-read" class="quarto-xref">Example&nbsp;<span>9.1</span></a> provides some structural information about the dataset, number of rows and columns as well as variable types.</p>
<p>After performing some diagnostics, the dataset is in good order to proceed with the analysis. I updated the variables <code>subcorpus</code> and <code>proficiency</code> as factor variables and ordered them in a way that makes sense for the analysis. The <code>placement_score</code> variable is distributed well across the proficiency levels. The <code>subcorpus</code> variable is less balanced, with around 65% of the texts being from learners. This is not a problem, but it is something to keep in mind when interpreting the results of the analysis.</p>
<p>We will be using the <code>tidymodels</code> framework in R to perform this analysis. <code>tidymodels</code> is a metapackage, much like <code>tidyverse</code>, that provides a consistent interface for modeling and machine learning. Some key packages unique to <code>tidymodels</code> are <code>recipes</code>, <code>parsnip</code>, <code>workflows</code>, and <code>tune</code>. <code>recipes</code> includes functions for preprocessing and engineering features. <code>parsnip</code> provides a consistent interface for specifying modeling algorithms. <code>worflows</code> allows us to combine recipes and models into a single pipeline. Finally, <code>tune</code> give us the ability to evaluate and tune hyperparameters of models.</p>
<p>Since we are using text data, we will also be using the <code>textrecipes</code> package which makes various functions available for preprocessing text including extracting and engineering features.</p>
<p>Let’s go ahead and do the setup, loading the necessary packages, seen in <a href="#exm-pda-packages-data" class="quarto-xref">Example&nbsp;<span>9.2</span></a>.</p>
<div id="exm-pda-packages-data" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.2</strong></span> &nbsp;</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span>   <span class="co"># modeling metapackage</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/textrecipes">textrecipes</a></span><span class="op">)</span>  <span class="co"># text preprocessing</span></span>
<span></span>
<span><span class="co"># Set global options</span></span>
<span><span class="fu"><a href="https://tidymodels.tidymodels.org/reference/tidymodels_prefer.html">tidymodels_prefer</a></span><span class="op">(</span><span class="op">)</span>   <span class="co"># prefer tidymodels functions over other functions with the same name</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="sec-pda-text-classification" class="level3" data-number="9.2.1"><h3 data-number="9.2.1" class="anchored" data-anchor-id="sec-pda-text-classification">
<span class="header-section-number">9.2.1</span> Text classification</h3>
<!-- Research question: outcome and features -->
<p>The goal of this analysis is to classify texts as either native or learner based on the writing samples. This is a binary classification problem. We will approach this problem from an exploratory perspective, and therefore our aim is to identify features from the text that best distinguish between the two classes.</p>
<p>Let’s modify the data frame to include only the variables we need for this analysis, assigning it to <code>cls_tbl</code>. In the process, we will rename the <code>subcorpus</code> variable to <code>outcome</code> to reflect that it is the outcome variable. This is seen in <a href="#exm-pda-class-data" class="quarto-xref">Example&nbsp;<span>9.3</span></a>.</p>
<div id="exm-pda-class-data" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.3</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Rename subcorpus to outcome</span></span>
<span><span class="va">cls_tbl</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">cedel_tbl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span>outcome <span class="op">=</span> <span class="va">subcorpus</span>, <span class="va">proficiency</span>, <span class="va">text</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<!-- Step 1: identify features -->
<p>Let’s begin the workflow from <a href="#tbl-pda-workflow" class="quarto-xref">Table&nbsp;<span>9.1</span></a> by identifying the features that we will use to classify the texts. There may be many features that we could use. These could be features derived from raw text (<em>e.g.</em> characters, words, n-grams, <em>etc.</em>), feature vectors (<em>e.g.</em> word embeddings), or meta-linguistic features (<em>e.g.</em> part-of-speech tags, syntactic parses, or semantic features) that have been derived from these through manual or automatic annotation.</p>
<p>Let’s start simple and use words as the predictor features. This is a simple approach that is often used as a baseline for more complex models. If it doesn’t work well, we can always try something else.</p>
<p>This provides us the linguistic unit we will use but we still need to decide how to represent these words. Do we use raw token counts? Do we use normalized frequencies? Do we use some type of weighting scheme? These are questions that we need to consider as we embark on this analysis. Since we are exploring we can use trial-and-error or consider the implications of each approach and choose the one that best fits our research question –or both.</p>
<p>Let’s approach this with a bit more nuance as we already have some domain knowledge about language use. First, we know that in the distribution of linguistic units is highly skewed, meaning that a few words occur very frequently and most words occur very infrequently. Second, we know that the most frequent words in a language are often function words (<em>e.g.</em> ‘the’, ‘and’, ‘of’, <em>etc.</em>) and that these words are tend not very informative for distinguishing between classes of texts. Third, we know that comparing raw counts across texts conflates the influence text class lengths.</p>
<p>With these considerations in mind, we will tokenize the text into words and then use the term frequency-inverse document frequency (TF-IDF) weighting scheme to represent the words. This scheme will down weight words that are common across all documents and up weight words that are unique to a document. It also mitigates the varying lengths of the documents. This is a common approach in text classification and is a good starting point for our analysis.</p>
<!-- Step 2: Initial split -->
<p>With our features identified, we can move on to step 2 of our workflow and split the data into training and testing sets. We make the splits to our data at this point to draw a line in the sand between the data we will use to train the model and the data we will use to test the model. A typical approach in supervised machine learning is to allocate around 75-80% of the data to the training set and the remaining 20-25% to the testing set, depending on the number of observations. We have 2957 observations in our data set, so we can allocate 80% of the data to the training set and 20% of the data to the testing set.</p>
<p>In <a href="#exm-pda-class-split" class="quarto-xref">Example&nbsp;<span>9.4</span></a>, we will use the <code>initial_split()</code> function from the <code>rsample</code> package to split the data into training and testing sets. The <code>initial_split()</code> function takes a data frame and a proportion and returns a <code>split</code> object which contains the training and testing sets. We will use the <code>strata</code> argument to stratify the data by the <code>outcome</code> variable. This will ensure that the training and testing sets have the same proportion of native and learner texts.</p>
<div id="exm-pda-class-split" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.4</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Set seed for reproducibility</span></span>
<span></span>
<span></span>
<span><span class="co"># Split the data into training and testing sets</span></span>
<span><span class="va">cls_split</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">initial_split</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">cls_tbl</span>,</span>
<span>    prop <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>    strata <span class="op">=</span> <span class="va">outcome</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Create training set</span></span>
<span><span class="va">cls_train</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">cls_split</span><span class="op">)</span>  <span class="co"># 80% of data</span></span>
<span></span>
<span><span class="co"># Create testing set</span></span>
<span><span class="va">cls_test</span> <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">cls_split</span><span class="op">)</span>    <span class="co"># 20% of data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>A confirmation of the distribution of the data across the training and testing sets as well as a break down of the outcome variable can be seen in <a href="#exm-pda-class-split-tabyl" class="quarto-xref">Example&nbsp;<span>9.5</span></a>.</p>
<div id="exm-pda-class-split-tabyl" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.5</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># View the distribution of the outcome variables</span></span>
<span><span class="va">cls_train</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tabyl</span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">adorn_totals</span><span class="op">(</span><span class="st">"row"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">adorn_pct_formatting</span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt;  outcome    n percent
&gt;  Learner 1524   64.5%
&gt;   Native  840   35.5%
&gt;    Total 2364  100.0%</code></pre>
</div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cls_test</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tabyl</span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">adorn_totals</span><span class="op">(</span><span class="st">"row"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">adorn_pct_formatting</span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt;  outcome   n percent
&gt;  Learner 382   64.4%
&gt;   Native 211   35.6%
&gt;    Total 593  100.0%</code></pre>
</div>
</div>
</div>
<p>We can see that the split was successful. The training and testing sets have very similiar proportion of native and learner texts.</p>
<!-- Step 3: Integrate: plan to select and engineer features -->
<!-- [ ] change the 'feature variable' to 'predictor variable' to be in line with the recipes nomenclature  -->
<!-- CONTINUE HERE:

Remember, I've adjusted the starting point for our features to: tf-idf weighting scheme. This will affect a significant portion of the following content.

- leave the tokenfilter at a hardcoded number to start
- point out that we use L1 normalization to avoid particular words dominating the feature space, this is analogous to the standardization of numeric features, such as those used in PCA or regression analysis where the magnitude of the features can affect the model's performance.

-->
<p>We are now ready to create a ‘recipe’, step 3 in our analysis. A recipe is a set of instructions or blueprint which specify the outcome variable and the predictor variable and determines how to preprocess and engineer the feature variables.</p>
<p>We will use the <code><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe()</a></code> function from the <code>recipes</code> package to create the recipe. The <code><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe()</a></code> function minimally takes a formula and a data frame and returns a <code>recipe</code> object. The formula specifies the outcome variable (<span class="math inline">\(y\)</span>) and the predictor variable(s) (<span class="math inline">\(x_1 .. x_n\)</span>). For example <code>y ~ x</code> can be read as “y as a function of x”. In our particular case, we will use the formula <code>outcome ~ text</code> to specify that the outcome variable is the <code>outcome</code> variable and the predictor variable is the <code>text</code> variable. The code is seen in <a href="#exm-pda-class-recipe" class="quarto-xref">Example&nbsp;<span>9.6</span></a>.</p>
<div id="exm-pda-class-recipe" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.6</strong></span> &nbsp;</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create a recipe</span></span>
<span><span class="va">base_rec</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">outcome</span> <span class="op">~</span> <span class="va">text</span>,</span>
<span>    data <span class="op">=</span> <span class="va">cls_train</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">base_rec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The recipe object at this moment contains just one instruction, what the variables are and what their relationship is.</p>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong><i class="fa-regular fa-hand-point-up" aria-label="hand-point-up"></i> Tip</strong></p>
<p>R formulas are a powerful way to specify relationships between variables and are used extensively in data modeling including exploratory, predictive, and inferential analysis. The basic formula syntax is <code>y ~ x</code> where <code>y</code> is the outcome variable and <code>x</code> is the feature variable. The formula syntax can be extended to include multiple feature variables, interactions, and transformations. For more information on R formulas, see <a href="https://r4ds.github.io/bookclub-tmwr/r-formula-syntax.html">R for Data Science</a>.</p>
</div>
</div>
</div>
<p>The <code>recipes</code> package provides a wide range of <code>step_*()</code> functions which can be applied to the recipe to specify how to engineer the variables in our recipe call. These include functions to scale (<em>e.g</em> <code><a href="https://recipes.tidymodels.org/reference/step_center.html">step_center()</a></code>, <code><a href="https://recipes.tidymodels.org/reference/step_scale.html">step_scale()</a></code>, <em>etc.</em>) and transform (<em>e.g.</em> <code><a href="https://recipes.tidymodels.org/reference/step_log.html">step_log()</a></code>, <code><a href="https://recipes.tidymodels.org/reference/step_pca.html">step_pca()</a></code>, <em>etc.</em>) numeric variables, and functions to encode (<em>e.g.</em> <code><a href="https://recipes.tidymodels.org/reference/step_dummy.html">step_dummy()</a></code>, <code>step_labelencode()</code>, <em>etc.</em>) categorical variables.</p>
<p>These step functions are great when we have selected the variables we want to use in our model and we want to engineer them in a particular way. In our case, however, we need to derive features from the text in the <code>text</code> column of datasets before we engineer them. To ease this process, the <code>textrecipes</code> package provides a number of step functions for preprocessing text data. These include functions to tokenize (<em>e.g.</em> <code><a href="https://textrecipes.tidymodels.org/reference/step_tokenize.html">step_tokenize()</a></code>), remove stop words (<em>e.g.</em> <code><a href="https://textrecipes.tidymodels.org/reference/step_stopwords.html">step_stopwords()</a></code>), and to derive meta-features (<em>e.g.</em> <code><a href="https://textrecipes.tidymodels.org/reference/step_lemma.html">step_lemma()</a></code>, <code><a href="https://textrecipes.tidymodels.org/reference/step_stem.html">step_stem()</a></code>, <em>etc.</em>) <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. Furthermore, there are functions to engineer features in ways that are particularly relevant to text data, such as feature frequencies and weights (<em>e.g.</em> <code><a href="https://textrecipes.tidymodels.org/reference/step_tf.html">step_tf()</a></code>, <code><a href="https://textrecipes.tidymodels.org/reference/step_tfidf.html">step_tfidf()</a></code>, <em>etc.</em>) and token filtering (<em>e.g.</em> <code><a href="https://textrecipes.tidymodels.org/reference/step_tokenfilter.html">step_tokenfilter()</a></code>).</p>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong><i class="fa-solid fa-medal" aria-label="medal"></i> Dive deeper</strong></p>
<p>For text processing steps for Japanese, see the <code>washoku</code> package <span class="citation" data-cites="R-washoku">(<a href="references.html#ref-R-washoku" role="doc-biblioref">Uryu 2024</a>)</span>.</p>
</div>
</div>
</div>
<p>So let’s build on our basic recipe <code>cls_rec</code> by adding steps relevant to our task. To extract our features, we will use the <code><a href="https://textrecipes.tidymodels.org/reference/step_tokenize.html">step_tokenize()</a></code> function to tokenize the text into words. The default behavior of the <code><a href="https://textrecipes.tidymodels.org/reference/step_tokenize.html">step_tokenize()</a></code> function is to tokenize the text into words, but other token units can be derived and various options can be added to the function call (as the <code>tokenizers</code> package is used under the hood). Adding the <code><a href="https://textrecipes.tidymodels.org/reference/step_tokenize.html">step_tokenize()</a></code> function to our recipe is seen in <a href="#exm-pda-class-recipe-tokenize" class="quarto-xref">Example&nbsp;<span>9.7</span></a>.</p>
<div id="exm-pda-class-recipe-tokenize" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.7</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Add step to tokenize the text</span></span>
<span><span class="va">cls_rec</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">base_rec</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tokenize.html">step_tokenize</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">cls_rec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The recipe object now contains two instructions, one for the outcome variable and one for the feature variable. The feature variable instruction specifies that the text should be tokenized into words.</p>
<p>We now need to consider how to engineer the word features. If we add <code><a href="https://textrecipes.tidymodels.org/reference/step_tf.html">step_tf()</a></code> we will get a matrix of token counts by default. We also have the option to add <code><a href="https://textrecipes.tidymodels.org/reference/step_tfidf.html">step_tfidf()</a></code> to get a matrix of term frequencies weighted by inverse document frequency, which effectively down weights words that are common across all documents.</p>
<p>We decided in step 1 that we will start with raw token counts, so we will add <code><a href="https://textrecipes.tidymodels.org/reference/step_tf.html">step_tf()</a></code> to our recipe. This is seen in <a href="#exm-pda-class-recipe-tf" class="quarto-xref">Example&nbsp;<span>9.8</span></a>.</p>
<div id="exm-pda-class-recipe-tf" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.8</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Add step to tokenize the text</span></span>
<span><span class="va">cls_rec</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">cls_rec</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tf.html">step_tf</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">cls_rec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<!-- Step 4: Inspect:  -->
<p>To make sure things are in order and that the recipe performs as expected, we can use the functions <code><a href="https://recipes.tidymodels.org/reference/prep.html">prep()</a></code> and <code><a href="https://recipes.tidymodels.org/reference/bake.html">bake()</a></code> to inspect the recipe. The <code><a href="https://recipes.tidymodels.org/reference/prep.html">prep()</a></code> function takes a recipe object and a data frame and returns a <code>prep</code> object. The <code>prep</code> object contains the recipe and the data frame with the feature variables engineered according to the recipe. The <code><a href="https://recipes.tidymodels.org/reference/bake.html">bake()</a></code> function takes a <code>prep</code> object and an optional new dataset to apply the recipe to. If we only want to see the application to the training set, we can use the <code>new_data = NULL</code> argument.</p>
<p>In <a href="#exm-pda-class-recipe-prep" class="quarto-xref">Example&nbsp;<span>9.9</span></a>, we use the <code><a href="https://recipes.tidymodels.org/reference/prep.html">prep()</a></code> and <code><a href="https://recipes.tidymodels.org/reference/bake.html">bake()</a></code> functions to create a data frame with the feature variables. We can then inspect the data frame to see if the recipe performed as expected.</p>
<div id="exm-pda-class-recipe-prep" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.9</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Prep and bake</span></span>
<span><span class="va">cls_bake</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">cls_rec</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html">prep</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># create a prep object</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html">bake</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="co"># apply to training set</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">cls_bake</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; [1]  2364 38115</code></pre>
</div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cls_bake</span><span class="op">[</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">:</span><span class="fl">1001</span>, <span class="fl">2000</span><span class="op">:</span><span class="fl">2001</span><span class="op">)</span>,     <span class="co"># selected rows</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1000</span><span class="op">:</span><span class="fl">1001</span>, <span class="fl">20000</span><span class="op">:</span><span class="fl">20001</span><span class="op">)</span> <span class="co"># selected columns</span></span>
<span>  <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 4 × 5
&gt;   outcome tf_text_actuales tf_text_actualiadad tf_text_iniciáticas
&gt;   &lt;fct&gt;              &lt;int&gt;               &lt;int&gt;               &lt;int&gt;
&gt; 1 Learner                0                   0                   0
&gt; 2 Learner                0                   0                   0
&gt; 3 Native                 0                   0                   0
&gt; 4 Native                 0                   0                   0
&gt; # ℹ 1 more variable: tf_text_iniciativa &lt;int&gt;</code></pre>
</div>
</div>
</div>
<p>The resulting engineered features data frame has 2364 observations and 38115 variables. The first variable is the outcome variable and the remaining variables are the engineered features. We can see that the recipe performed as expected and that the feature variables are the token counts for each word in the text.</p>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong><i class="fa-regular fa-hand-point-up" aria-label="hand-point-up"></i> Tip</strong></p>
<p>When applying tokenization and feature engineering steps to text data the result is often contained in a matrix object. Using the <code>recipes</code> package a data frame with a matrix-like structure is returned.</p>
<p>Furthermore, the features are prefixed with the variable name and transformation step labels. In <a href="#exm-pda-class-recipe-prep" class="quarto-xref">Example&nbsp;<span>9.9</span></a> we applied term frequency to the <code>text</code> variable. Therefore we see that our features are prefixed with <code>tf_text_</code>.</p>
</div>
</div>
</div>
<p>But we should pause. We have a lot of features! One for every single word in the entire corpus. This is an unweildy number of features for a model and it is likely that many of these features are not useful for our classification task. Furthermore, the more features we have, the more chance these features capture the nuances of these particular writing samples, thus, we are the more likely we are to overfit the model. All in all, we need to reduce the number of features.</p>
<p>Our domain knowledge about language can be of help us decide on how to approach reducing the feature set. On the one hand, we know that most tokens occur rarely in any sizable corpus. And the lower the frequency, the more likely that the token may reflect nuances of the speaker or the content of particular texts rather than generalizable trends. On the other hand, we know that a relatively small number of the most frequent words quickly account for a large proportion of the tokens in a corpus.</p>
<p>So just with these two considerations, we can see that we can filter out many infrequent words and likely have quite a few viable features. Let’s start with an arbitrary threshold of the top 1,000 words by frequency. We can use the <code><a href="https://textrecipes.tidymodels.org/reference/step_tokenfilter.html">step_tokenfilter()</a></code> function to filter out the top 1,000 words by frequency. This particular step needs to be applied before the <code><a href="https://textrecipes.tidymodels.org/reference/step_tf.html">step_tf()</a></code> step, so we will add it to our recipe before the <code><a href="https://textrecipes.tidymodels.org/reference/step_tf.html">step_tf()</a></code> step. This is seen in <a href="#exm-pda-class-recipe-tokenfilter" class="quarto-xref">Example&nbsp;<span>9.10</span></a>.</p>
<div id="exm-pda-class-recipe-tokenfilter" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.10</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Rebuild recipe with tokenfilter step</span></span>
<span><span class="va">cls_rec</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">base_rec</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tokenize.html">step_tokenize</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tokenfilter.html">step_tokenfilter</a></span><span class="op">(</span><span class="va">text</span>, max_tokens <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tf.html">step_tf</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prep and bake</span></span>
<span><span class="va">cls_bake</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">cls_rec</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html">prep</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html">bake</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">cls_bake</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; [1] 2364 1001</code></pre>
</div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cls_bake</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 5 × 10
&gt;   outcome tf_text_10 tf_text_2 tf_text_3 tf_text_4 tf_text_a tf_text_abandonado
&gt;   &lt;fct&gt;        &lt;int&gt;     &lt;int&gt;     &lt;int&gt;     &lt;int&gt;     &lt;int&gt;              &lt;int&gt;
&gt; 1 Learner          0         0         0         0         0                  0
&gt; 2 Learner          0         0         0         0         2                  0
&gt; 3 Learner          0         1         0         0         5                  0
&gt; 4 Learner          0         0         0         0         0                  0
&gt; 5 Learner          0         0         0         0         2                  0
&gt; # ℹ 3 more variables: tf_text_abuela &lt;int&gt;, tf_text_abuelos &lt;int&gt;,
&gt; #   tf_text_aburrido &lt;int&gt;</code></pre>
</div>
</div>
</div>
<p>We now have a manageable set of features. Only during the interrogation step will we know if they are useful.</p>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong><i class="fa-regular fa-hand-point-up" aria-label="hand-point-up"></i> Tip</strong></p>
<p>The <code><a href="https://recipes.tidymodels.org/reference/prep.html">prep()</a></code> and <code><a href="https://recipes.tidymodels.org/reference/bake.html">bake()</a></code> functions are useful for inspecting the recipe and the engineered features, but they are not required to build a recipe. When a recipe is added to a workflow, the <code><a href="https://recipes.tidymodels.org/reference/prep.html">prep()</a></code> and <code><a href="https://recipes.tidymodels.org/reference/bake.html">bake()</a></code> functions are called automatically as part of the process.</p>
</div>
</div>
</div>
<p>There is one last step we should add to our recipe which concerns the skewed nature of word frequency distributions. The magnitude of the token counts will be highly skewed with a few words having very high counts and most words having relatively low counts, even for the top 1,000 words. This skew can be problematic for some models, so we will add a step to log normalize the token counts. This will not change the rank order, only the magnitude of the differences. Note that we use <code><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors()</a></code> to apply the log transformation to all the word features, as seen in <a href="#exm-pda-class-recipe-log" class="quarto-xref">Example&nbsp;<span>9.11</span></a>.</p>
<div id="exm-pda-class-recipe-log" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.11</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Add log step to recipe</span></span>
<span><span class="va">cls_rec</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">cls_rec</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_log.html">step_log</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span><span class="op">(</span><span class="op">)</span>, offset <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># add 1 to avoid log(0)</span></span>
<span></span>
<span><span class="va">cls_rec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<!-- Step 5: Interrogate -->
<p>We are now ready to turn our attention to step 5 of our workflow, interrogating the data. In this step, we will first select a classification algorithm, then add this algorithm and our recipe to a workflow object. We will then use the workflow object to train and evaluate the model on the training set.</p>
<!-- Select a classification algorithm -->
<p>There are many classification algorithms to choose from with their own strengths and shortcomings. In <a href="#tbl-pda-class-algorithms" class="quarto-xref">Table&nbsp;<span>9.3</span></a>, we list some of the most common classification algorithms and their characteristics.</p>
<div id="tbl-pda-class-algorithms" class="striped quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-pda-class-algorithms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;9.3: Classification algorithms
</figcaption><div aria-describedby="tbl-pda-class-algorithms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table-striped table">
<colgroup>
<col style="width: 30%">
<col style="width: 30%">
<col style="width: 38%">
</colgroup>
<thead><tr class="header">
<th>Algorithm</th>
<th>Strengths</th>
<th>Shortcomings</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Logistic regression</td>
<td>Simple, interpretable, fast</td>
<td>Assumes linear relationship between features and outcome</td>
</tr>
<tr class="even">
<td>Naive Bayes</td>
<td>Simple, interpretable, fast</td>
<td>Assumes independence between features</td>
</tr>
<tr class="odd">
<td>Decision trees</td>
<td>Nonlinear relationships, interpretable</td>
<td>Prone to overfitting</td>
</tr>
<tr class="even">
<td>Random forest</td>
<td>Nonlinear relationships, interpretable</td>
<td>Prone to overfitting</td>
</tr>
<tr class="odd">
<td>Support vector machines</td>
<td>Nonlinear relationships, interpretable</td>
<td>Prone to overfitting</td>
</tr>
<tr class="even">
<td>Neural networks</td>
<td>Nonlinear relationships, fast</td>
<td>Prone to overfitting, difficult to interpret</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<!-- Models: simple to complex  -->
<p>In the process of selecting an algorithm, simple, computationally efficient, and interpretable models are preferred over complex, computationally expensive, and uninterpretable models, all things being equal. Only if the performance of the simple model is not good enough should we move on to a more complex model.</p>
<p>With this end mind, we will start with a simple logistic regression model to see how well we can classify the texts in the training set with the features we have engineered. We will use the <code>logistic_reg()</code> function from the <code>parsnip</code> package to specify the logistic regression model. We then select the implementation engine (<code>glm</code> General Linear Model) and the mode of the model (<code>classification</code>). The implementation engine is the software that will be used to fit the model. The mode is the type of model, either classification or regression. The code is seen in <a href="#exm-pda-class-model-spec" class="quarto-xref">Example&nbsp;<span>9.12</span></a>.</p>
<div id="exm-pda-class-model-spec" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.12</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create a model specification</span></span>
<span><span class="va">cls_spec</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">logistic_reg</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"glm"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">cls_spec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; Logistic Regression Model Specification (classification)
&gt; 
&gt; Computational engine: glm</code></pre>
</div>
</div>
</div>
<p>In the <code>parsnip</code> package, model specifications are separate from model fitting. This allows us to specify the model once and then fit the model with different datasets. Furthermore, different algorithms will have different hyperparameters that can be tuned. The code in <a href="#exm-pda-class-model-spec" class="quarto-xref">Example&nbsp;<span>9.12</span></a> uses the default hyperparameters for the logistic regression model.</p>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong><i class="fa-regular fa-hand-point-up" aria-label="hand-point-up"></i> Tip</strong></p>
<p>The <code>parsnip</code> package provides a consistent interface to many different models, 105 at the time of writing. You can peruse the list of models by running <code><a href="https://parsnip.tidymodels.org/reference/model_db.html">parsnip::model_db</a></code>.</p>
<p>You can also retrieve the list of potential engines for a given model specification with the <code>show_engines()</code> function. For example, <code>show_engines("logistic_reg")</code> will return a tibble with the engines available for the logistic regression model specification.</p>
</div>
</div>
</div>
<p>Now we will combine our recipe and model specification into a workflow object. The workflow object will allow us to train and evaluate the model on the training set. We will use the <code>workflow()</code> function from the <code>workflows</code> package to combine the recipe and model specification into a workflow object. The code is seen in <a href="#exm-pda-class-workflow" class="quarto-xref">Example&nbsp;<span>9.13</span></a>.</p>
<div id="exm-pda-class-workflow" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.13</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create a workflow</span></span>
<span><span class="va">cls_wf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">cls_rec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">cls_spec</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">cls_wf</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; ══ Workflow ════════════════════════════════════════════════════════════════════
&gt; Preprocessor: Recipe
&gt; Model: logistic_reg()
&gt; 
&gt; ── Preprocessor ────────────────────────────────────────────────────────────────
&gt; 4 Recipe Steps
&gt; 
&gt; • step_tokenize()
&gt; • step_tokenfilter()
&gt; • step_tf()
&gt; • step_log()
&gt; 
&gt; ── Model ───────────────────────────────────────────────────────────────────────
&gt; Logistic Regression Model Specification (classification)
&gt; 
&gt; Computational engine: glm</code></pre>
</div>
</div>
</div>
<p>The worflow contains all the preprocessing and the model-specific parameters we’ve selected. A workflow object at this stage in the analysis is not trained. It is a blueprint for a model. We can use the <code>fit()</code> function to apply the workflow to the training data to train the model and update our workflow object with the trained model. The <code>fit()</code> function takes a workflow and a data frame and returns an updated workflow object which is trained. The code is seen in <a href="#exm-pda-class-workflow-fit" class="quarto-xref">Example&nbsp;<span>9.14</span></a>.</p>
<!-- [ ] should I jump straight to 'fit()'? Maybe stress the importance of cross-validation from the get go? -->
<div id="exm-pda-class-workflow-fit" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.14</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Fit the workflow</span></span>
<span><span class="va">cls_wf_fit</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">fit</span><span class="op">(</span></span>
<span>    <span class="va">cls_wf</span>,</span>
<span>    data <span class="op">=</span> <span class="va">cls_train</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The workflow object now contains the trained model. But things did not go off without a hitch. We receive two warning messages when fitting the workflow to the training data:</p>
<pre><code>Warning messages:
1: glm.fit: algorithm did not converge
2: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
<p>Warning messages are a sign that something may be amiss with the features we have choosen, the model we have selected, or both! Warning messages can sometimes be cryptic and steeped in the jargon of the algorithm. When in doubt it is best to consult the documentation of the algorithm and/ or seek help from the R community.</p>
<p>The first warning, the ‘algorithm did not converge’, means that given the data and the model, the algorithm could not estimate a stable solution. The reason or reasons for this can be varied, but it typically due to extreme outliers, collinearity, or a small sample size. Collinearity is when two or more features are highly correlated. Given we are using words as features, it is likely that there is collinearity in the data. We will need to address this.</p>
<p>The second warning is ‘fitted probabilities numerically 0 or 1 occurred’. This means that the model is overfitting the data, (i.e.&nbsp;there are one or more features that perfectly predict the outcome). This very well could be related to the first warning, as a small set of features may be perfectly predicting the outcome in a way that will likely not generalize to new data.</p>
<p>The upshot is that this model specification and/ or the feature engineering needs to be changed. So we step back in the workflow and make changes that will cascade downstream.</p>
<p>It turns out that a regularized logistic regression model often addresses the issues this model is experiencing. We will use the <code>glmnet</code> engine to fit a regularized logistic regression model. It is a more complex complex approach, but it can often mitigate the issues of collinearity and overfitting by penalizing features that are highly correlated and by shrinking the coefficients of features that are not useful for predicting the outcome.</p>
<p>We will build a new model specification using the <code>logistic_reg()</code> function and the <code>glmnet</code> engine. This time we will use hyperparameters in our <code>logistic_reg()</code> call to specify the penality we want to use and the strength of the penality. The penalty we will use is the LASSO (L1)<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. We now need to decide what value to use for the strength of the penalty, 0 to 1, where 0 indicates no penalty and 1 indicates a maximum penalty. We either experiment with different values one by one or we can implement a range of values in tandem and then select the best value. We will use the latter approach.</p>
<p>The <code>tune</code> package provides a number of functions for selecting, or ‘tuning’, hyperparameters. The first is the <code>tune()</code> function which we add as the argument of the hyperparameter we want to tune in the model specification, as seen in <a href="#exm-pda-class-model-spec-tune" class="quarto-xref">Example&nbsp;<span>9.15</span></a>.</p>
<div id="exm-pda-class-model-spec-tune" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.15</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create a model specification for tuning</span></span>
<span><span class="va">cls_spec_tune</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">logistic_reg</span><span class="op">(</span>penalty <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>, mixture <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"glmnet"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a workflow</span></span>
<span><span class="va">cls_wf_tune</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">cls_rec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">cls_spec_tune</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>We now have a workflow that includes the <code>tune()</code> function as a placeholder for a range of values for the penalty hyperparameter. We use the <code>grid_regular()</code> function from the <code>dials</code> package to specify a grid of values for the penalty hyperparameter. Let’s choose a random set of 10 values, as seen in <a href="#exm-pda-class-model-spec-tune-grid-values" class="quarto-xref">Example&nbsp;<span>9.16</span></a>.</p>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong><i class="fa-solid fa-medal" aria-label="medal"></i> Dive deeper</strong></p>
<p>The hyperparameters <code>penalty</code> and <code>mixture</code> control which type(s) of regularization to apply and if there is a mixing of the types. In the model specification in <a href="#exm-pda-class-model-spec-tune" class="quarto-xref">Example&nbsp;<span>9.15</span></a>, the <code>penalty</code> is set to be tuned and the <code>mixture</code> is set to 1, which means that only a lasso penalty will be applied.</p>
<p>See the documentation for the <code><a href="https://parsnip.tidymodels.org/reference/logistic_reg.html">parsnip::logistic_reg()</a></code> function for more information.</p>
</div>
</div>
</div>
<div id="exm-pda-class-model-spec-tune-grid-values" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.16</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create a grid of values for the penalty hyperparameter</span></span>
<span><span class="va">cls_grid</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">grid_regular</span><span class="op">(</span></span>
<span>    <span class="fu">penalty</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    levels <span class="op">=</span> <span class="fl">10</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">cls_grid</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 10 × 1
&gt;          penalty
&gt;            &lt;dbl&gt;
&gt;  1 0.0000000001 
&gt;  2 0.00000000129
&gt;  3 0.0000000167 
&gt;  4 0.000000215  
&gt;  5 0.00000278   
&gt;  6 0.0000359    
&gt;  7 0.000464     
&gt;  8 0.00599      
&gt;  9 0.0774       
&gt; 10 1</code></pre>
</div>
</div>
</div>
<p>The 10 values chosen to be in the grid range from nearly zero to 1, where 0 indicates no penalty and 1 indicates a strong penalty.</p>
<p>Now to perform the tuning and arrive at an optimal value for <code>penalty</code> we need to create a tuning workflow. We do this by calling the <code>tune_grid()</code> function using our tuning model specification workflow, a resampling object, and our hyperparameter grid and returns a <code>tune_grid</code> object.</p>
<p>Now, a resampling object is not something we’ve seen yet. Resampling is a strategy that allows us to generate multiple training and testing sets from a single data set –in this case the training data we split at the outset. Each variation of the training and testing sets is called a fold. Which is why this type of resampling is called k-fold cross-validation. The <code>vfold_cv()</code> function from the <code>rsample</code> package takes a data frame and a number of folds and returns a <code>vfold_cv</code> object. We will use 10 folds and include the model specification and the hyperparameter grid in the <code>tune_grid()</code> function call. The code is seen in <a href="#exm-pda-class-model-spec-tune-grid-cv" class="quarto-xref">Example&nbsp;<span>9.17</span></a>.</p>
<div id="exm-pda-class-model-spec-tune-grid-cv" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.17</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a resampling object</span></span>
<span><span class="va">cls_vfold</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">vfold_cv</span><span class="op">(</span></span>
<span>    <span class="va">cls_train</span>,</span>
<span>    v <span class="op">=</span> <span class="fl">10</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># Tune the model</span></span>
<span><span class="va">cls_tune</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">tune_grid</span><span class="op">(</span></span>
<span>    <span class="va">cls_wf_tune</span>,</span>
<span>    resamples <span class="op">=</span> <span class="va">cls_vfold</span>,</span>
<span>    grid <span class="op">=</span> <span class="va">cls_grid</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">cls_tune</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # Tuning results
&gt; # 10-fold cross-validation 
&gt; # A tibble: 10 × 4
&gt;    splits             id     .metrics          .notes          
&gt;    &lt;list&gt;             &lt;chr&gt;  &lt;list&gt;            &lt;list&gt;          
&gt;  1 &lt;split [2127/237]&gt; Fold01 &lt;tibble [20 × 5]&gt; &lt;tibble [0 × 3]&gt;
&gt;  2 &lt;split [2127/237]&gt; Fold02 &lt;tibble [20 × 5]&gt; &lt;tibble [0 × 3]&gt;
&gt;  3 &lt;split [2127/237]&gt; Fold03 &lt;tibble [20 × 5]&gt; &lt;tibble [0 × 3]&gt;
&gt;  4 &lt;split [2127/237]&gt; Fold04 &lt;tibble [20 × 5]&gt; &lt;tibble [0 × 3]&gt;
&gt;  5 &lt;split [2128/236]&gt; Fold05 &lt;tibble [20 × 5]&gt; &lt;tibble [0 × 3]&gt;
&gt;  6 &lt;split [2128/236]&gt; Fold06 &lt;tibble [20 × 5]&gt; &lt;tibble [0 × 3]&gt;
&gt;  7 &lt;split [2128/236]&gt; Fold07 &lt;tibble [20 × 5]&gt; &lt;tibble [0 × 3]&gt;
&gt;  8 &lt;split [2128/236]&gt; Fold08 &lt;tibble [20 × 5]&gt; &lt;tibble [0 × 3]&gt;
&gt;  9 &lt;split [2128/236]&gt; Fold09 &lt;tibble [20 × 5]&gt; &lt;tibble [0 × 3]&gt;
&gt; 10 &lt;split [2128/236]&gt; Fold10 &lt;tibble [20 × 5]&gt; &lt;tibble [0 × 3]&gt;</code></pre>
</div>
</div>
</div>
<p>The <code>cls_tune</code> object contains the results of the tuning for each fold. We can see the results of the tuning for each fold by calling the <code>collect_metrics()</code> function on the <code>cls_tune</code> object, as seen in <a href="#exm-pda-class-model-spec-tune-grid-collect" class="quarto-xref">Example&nbsp;<span>9.18</span></a>.</p>
<div id="exm-pda-class-model-spec-tune-grid-collect" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.18</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Collect the results of the tuning</span></span>
<span><span class="va">cls_tune_metrics</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="va">cls_tune</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize metrics</span></span>
<span><span class="va">cls_tune</span> <span class="op">|&gt;</span> <span class="fu">autoplot</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pda-class-model-spec-tune-grid-collect" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pda-class-model-spec-tune-grid-collect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="prediction_files/figure-html/fig-pda-class-model-spec-tune-grid-collect-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pda-class-model-spec-tune-grid-collect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.1: Metrics for each fold of the tuning process.
</figcaption></figure>
</div>
</div>
</div>
</div>
<p>The most common metrics for model performance in classification are accuracy and the area under the receiver operating characteristic curve (ROC-AUC). Accuracy is the proportion of correct predictions. The ROC-AUC is a measure of the trade-off between sensitivity and specificity. Sensitivity is the proportion of true positives that are correctly identified. Specificity is the proportion of true negatives that are correctly identified. The ROC-AUC is a measure of how well the model can distinguish between the two classes.</p>
<p>In the plot of the metrics, we can see that the many of the penalty values performed similarly, with a drop off in performance at the higher values. Conveniently, the <code>show_best()</code> function from the <code>tune</code> package takes a <code>tune_grid</code> object and returns the best performing hyperparameter values. The code is seen in <a href="#exm-pda-class-model-spec-tune-grid-collect-best" class="quarto-xref">Example&nbsp;<span>9.19</span></a>.</p>
<div id="exm-pda-class-model-spec-tune-grid-collect-best" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.19</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Show the best performing hyperparameter value</span></span>
<span><span class="va">cls_tune</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">show_best</span><span class="op">(</span>metric <span class="op">=</span> <span class="st">"roc_auc"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 5 × 7
&gt;         penalty .metric .estimator  mean     n std_err .config              
&gt;           &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
&gt; 1 0.00599       roc_auc binary     0.977    10 0.00312 Preprocessor1_Model08
&gt; 2 0.000464      roc_auc binary     0.972    10 0.00320 Preprocessor1_Model07
&gt; 3 0.0000359     roc_auc binary     0.970    10 0.00337 Preprocessor1_Model06
&gt; 4 0.0000000001  roc_auc binary     0.970    10 0.00342 Preprocessor1_Model01
&gt; 5 0.00000000129 roc_auc binary     0.970    10 0.00342 Preprocessor1_Model02</code></pre>
</div>
</div>
</div>
<p>We can make this selection programmatically by using the <code>select_best()</code> function. This function needs a metric to select by. We will use the ROC-AUC and select the best value for the penalty hyperparameter. The code is seen in <a href="#exm-pda-class-model-spec-tune-grid-collect-select" class="quarto-xref">Example&nbsp;<span>9.20</span></a>.</p>
<div id="exm-pda-class-model-spec-tune-grid-collect-select" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.20</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Select the best performing hyperparameter value</span></span>
<span><span class="va">cls_best</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">select_best</span><span class="op">(</span><span class="va">cls_tune</span>, metric <span class="op">=</span> <span class="st">"roc_auc"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">cls_best</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 1 × 2
&gt;   penalty .config              
&gt;     &lt;dbl&gt; &lt;chr&gt;                
&gt; 1 0.00599 Preprocessor1_Model08</code></pre>
</div>
</div>
</div>
<p>All of that to tune a hyperparameter! Now we can update the model specification and workflow with the best performing hyperparameter value using the previous <code>cls_wf_tune</code> workflow and the <code>finalize_workflow()</code> function. The <code>finalize_workflow()</code> function takes a workflow and the selected parameters and returns an updated <code>workflow</code> object, as seen in <a href="#exm-pda-class-tune-hyperparameters-update-workflow" class="quarto-xref">Example&nbsp;<span>9.21</span></a>.</p>
<div id="exm-pda-class-tune-hyperparameters-update-workflow" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.21</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Update model specification</span></span>
<span><span class="va">cls_wf_lasso</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">cls_wf_tune</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">finalize_workflow</span><span class="op">(</span><span class="va">cls_best</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cls_wf_lasso</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; ══ Workflow ════════════════════════════════════════════════════════════════════
&gt; Preprocessor: Recipe
&gt; Model: logistic_reg()
&gt; 
&gt; ── Preprocessor ────────────────────────────────────────────────────────────────
&gt; 4 Recipe Steps
&gt; 
&gt; • step_tokenize()
&gt; • step_tokenfilter()
&gt; • step_tf()
&gt; • step_log()
&gt; 
&gt; ── Model ───────────────────────────────────────────────────────────────────────
&gt; Logistic Regression Model Specification (classification)
&gt; 
&gt; Main Arguments:
&gt;   penalty = 0.00599484250318942
&gt;   mixture = 1
&gt; 
&gt; Computational engine: glmnet</code></pre>
</div>
</div>
</div>
<p>Our model specification and the worflow are updated with the parameters.</p>
<p>Let’s now return to fitting the workflow to the training set as we did before for the vanilla logistic regression model. As a reminder we are still working in step 5 of our workflow, interrogating the data. We identified and addressed potential issues in the model specification, leaving the feature selection the same.</p>
<p>We again fit the workflow to the training set, as seen in <a href="#exm-pda-class-tune-hyperparameters-fit" class="quarto-xref">Example&nbsp;<span>9.22</span></a>.</p>
<div id="exm-pda-class-tune-hyperparameters-fit" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.22</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Fit the workflow</span></span>
<span><span class="va">cls_wf_lasso_fit</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">fit</span><span class="op">(</span></span>
<span>    <span class="va">cls_wf_lasso</span>,</span>
<span>    data <span class="op">=</span> <span class="va">cls_train</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>No warnings, so that is a good sign! –Or at least a better sign than before.</p>
<p>Let’s evaluate the performance of the model on the training data. The <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> function takes a trained model specification and a data frame and returns a data frame with the predicted outcome. We can join these predicted outcomes with the actual outcomes in the training data. The <code>metrics()</code> function takes a data frame with the actual and predicted outcomes and returns a data frame with the metrics for the model. The code is seen in <a href="#exm-pda-class-tune-hyperparameters-evaluate" class="quarto-xref">Example&nbsp;<span>9.23</span></a>.</p>
<div id="exm-pda-class-tune-hyperparameters-evaluate" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.23</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Evaluate workflow</span></span>
<span><span class="va">cls_lasso_fit_preds</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">bind_cols</span><span class="op">(</span></span>
<span>    <span class="va">cls_train</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">cls_wf_lasso_fit</span>, <span class="va">cls_train</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate accuracy</span></span>
<span><span class="va">cls_lasso_fit_preds</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">metrics</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">outcome</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 2 × 3
&gt;   .metric  .estimator .estimate
&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
&gt; 1 accuracy binary         0.969
&gt; 2 kap      binary         0.932</code></pre>
</div>
</div>
</div>
<p>Again, no warnings, so we have a functioning model. It also has a high accuracy, but we know that this is not the most reliable metric for the robustness of the model on new data. Similar to what we did to tune the hyperparameters, we can use cross-validation to gauge the variability of the model. The <code>fit_resamples()</code> function takes a workflow and a resampling object and returns metrics for each fold. The code is seen in <a href="#exm-pda-class-tune-hyperparameters-evaluate-workflow-cv" class="quarto-xref">Example&nbsp;<span>9.24</span></a>.</p>
<div id="exm-pda-class-tune-hyperparameters-evaluate-workflow-cv" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.24</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Cross-validate workflow</span></span>
<span><span class="va">cls_lasso_cv</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">cls_wf_lasso</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fit_resamples</span><span class="op">(</span></span>
<span>    resamples <span class="op">=</span> <span class="va">cls_vfold</span>,</span>
<span>    control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>We want to aggregate the metrics across the folds to get a sense of the variability of the model. The <code>collect_metrics()</code> function takes the results of a cross-validation and returns a data frame with the metrics.</p>
<div id="exm-pda-class-tune-hyperparameters-evaluate-workflow-cv-collect" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.25</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Collect metrics</span></span>
<span><span class="va">cls_lasso_cv</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 2 × 6
&gt;   .metric  .estimator  mean     n std_err .config             
&gt;   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
&gt; 1 accuracy binary     0.921    10 0.00627 Preprocessor1_Model1
&gt; 2 roc_auc  binary     0.977    10 0.00312 Preprocessor1_Model1</code></pre>
</div>
</div>
</div>
<p>The accuracy has dropped, but is still very high. From these metrics it appears we have a good candidate model. In many cases, however, there may be further room for improvement. A good next step to in these cases is to evaluate the model errors and see if there are any patterns that can be addressed before evaluating the model on the test set.</p>
<p>For classification tasks, a good place to start is to visualize the confusion matrix to assess false negatives and false positives. The <code>conf_mat_resampled()</code> function takes a <code>fit_resamples</code> object and returns a table (<code>tidy = FALSE</code>) with the confusion matrix for the aggregated folds. We can pass this to the <code>autoplot()</code> function to plot as in <a href="#exm-pda-class-tune-hyperparameters-evaluate-workflow-cv-confusion" class="quarto-xref">Example&nbsp;<span>9.26</span></a>.</p>
<div id="exm-pda-class-tune-hyperparameters-evaluate-workflow-cv-confusion" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.26</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Plot confusion matrix</span></span>
<span><span class="va">cls_lasso_cv</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">conf_mat_resampled</span><span class="op">(</span>tidy <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">autoplot</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"heatmap"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-class-tune-hyperparameters-evaluate-workflow-cv-confusion" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-class-tune-hyperparameters-evaluate-workflow-cv-confusion-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="prediction_files/figure-html/fig-class-tune-hyperparameters-evaluate-workflow-cv-confusion-1.png" class="img-fluid figure-img" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-class-tune-hyperparameters-evaluate-workflow-cv-confusion-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.2: Confusion matrix for the aggregated folds of the cross-validation.
</figcaption></figure>
</div>
</div>
</div>
</div>
<p>The top left to bottom right diagonal contains the true positives and true negatives. The top right to bottom left diagonal contains the false positives and false negatives. The convention is speak of one class being the positive class and the other class being the negative class. In our case, we will consider the positive class to be the ‘learner’ class and the negative class to be the ‘natives’ class.</p>
<p>We can see that there are more learners falsely predicted to be natives than the other way around. This may be due to the fact that there are simply more learners than natives in the data set or this could signal that there are some learners that are more similar to natives than other learners. Clearly this can’t be the entire explanation as the model is not perfect, even some natives are classified falsely as learners! But may be an interesting avenue for further exploration. Maybe these are learners that are more advanced or have a particular style of writing that is more similar to natives.</p>
<p>Another perspective often applied to evaluate a model is the Reciever Operating Characteristic (ROC) curve. The ROC curve is a plot of the true positive rate (TPR) against the false positive rate (FPR) for different classification thresholds. To produce the ROC curve, we pass the resampled fit to the <code>collect_preditions()</code> function. We then pass this result to <code>roc_curve()</code> function. But we want the results grouped by each fold, so we use <code>group_by(id)</code>. Finally, we can pass this to the <code>autoplot()</code> function to plot as in <a href="#exm-pda-class-tune-hyperparameters-evaluate-workflow-cv-roc" class="quarto-xref">Example&nbsp;<span>9.27</span></a>.</p>
<div id="exm-pda-class-tune-hyperparameters-evaluate-workflow-cv-roc" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.27</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Plot ROC curve</span></span>
<span><span class="va">cls_lasso_cv</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_predictions</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">roc_curve</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">outcome</span>, <span class="va">.pred_Learner</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">autoplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="st">"True positive rate"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"False positive rate"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Fold"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pda-class-tune-hyperparameters-evaluate-workflow-cv-roc" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pda-class-tune-hyperparameters-evaluate-workflow-cv-roc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="prediction_files/figure-html/fig-pda-class-tune-hyperparameters-evaluate-workflow-cv-roc-1.png" class="img-fluid figure-img" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pda-class-tune-hyperparameters-evaluate-workflow-cv-roc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.3: ROC curve for the aggregated folds of the cross-validation.
</figcaption></figure>
</div>
</div>
</div>
</div>
<p>In a ROC curve plot, each line represents a model’s performance for varying classification probability thresholds (from near 0 to 1, where 0.5 equal chance). The dotted line represents the null model (<em>i.e.</em> random guessing). The further the line is from the dotted line, along the top left to bottom right diagonal, the better the model. Thus, the larger the area under the curve (AUC) implies a more robust model for distinguishing between the two classes.</p>
<p>In <a href="#fig-pda-class-tune-hyperparameters-evaluate-workflow-cv-roc" class="quarto-xref">Figure&nbsp;<span>9.3</span></a>, each fold is plotted. We can see that the AUC is quite large for most of the folds which suggests that our model is robust.</p>
<!-- Step 6: Evaluate -->
<p>We are now ready to move on to step 7, evaluating the model on the test set. We will use the <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> function to predict the outcome on the test set. The <code>metrics()</code> function takes a data frame with the actual and predicted outcomes and returns a data frame with the metrics for the model. The code is seen in <a href="#exm-pda-class-tune-hyperparameters-evaluate-test" class="quarto-xref">Example&nbsp;<span>9.28</span></a>.</p>
<div id="exm-pda-class-tune-hyperparameters-evaluate-test" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.28</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># [ ] update to use `last_fit()`?</span></span>
<span></span>
<span><span class="va">cls_final_fit</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">last_fit</span><span class="op">(</span></span>
<span>    <span class="va">cls_wf_lasso</span>,</span>
<span>    split <span class="op">=</span> <span class="va">cls_split</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">cls_final_fit</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 2 × 4
&gt;   .metric  .estimator .estimate .config             
&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
&gt; 1 accuracy binary         0.927 Preprocessor1_Model1
&gt; 2 roc_auc  binary         0.972 Preprocessor1_Model1</code></pre>
</div>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Evaluate model on test set</span></span>
<span><span class="va">cls_lasso_fit_preds_test</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">bind_cols</span><span class="op">(</span></span>
<span>    <span class="va">cls_test</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">cls_wf_lasso_fit</span>, <span class="va">cls_test</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate accuracy</span></span>
<span><span class="va">cls_lasso_fit_preds_test</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">metrics</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">outcome</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 2 × 3
&gt;   .metric  .estimator .estimate
&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
&gt; 1 accuracy binary         0.927
&gt; 2 kap      binary         0.843</code></pre>
</div>
</div>
</div>
<p>The accuracy is as good as the training set, even a tad higher. This is a good sign that the model is robust as it performs well on both training and test sets. We can evaluate the confusion matrix on the test set as well. The code is seen in <a href="#exm-pda-class-tune-hyperparameters-evaluate-test-confusion" class="quarto-xref">Example&nbsp;<span>9.29</span></a>.</p>
<div id="exm-pda-class-tune-hyperparameters-evaluate-test-confusion" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.29</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Plot confusion matrix</span></span>
<span><span class="va">cls_lasso_fit_preds_test</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">conf_mat</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">outcome</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">autoplot</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"heatmap"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cls_final_fit</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_predictions</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">conf_mat</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">outcome</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">autoplot</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"heatmap"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pda-class-tune-hyperparameters-evaluate-test-confusion-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pda-class-tune-hyperparameters-evaluate-test-confusion-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="prediction_files/figure-html/fig-pda-class-tune-hyperparameters-evaluate-test-confusion-1.png" class="img-fluid figure-img" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pda-class-tune-hyperparameters-evaluate-test-confusion-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.4: Confusion matrix for the test set.
</figcaption></figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-pda-class-tune-hyperparameters-evaluate-test-confusion-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pda-class-tune-hyperparameters-evaluate-test-confusion-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="prediction_files/figure-html/fig-pda-class-tune-hyperparameters-evaluate-test-confusion-2.png" class="img-fluid figure-img" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pda-class-tune-hyperparameters-evaluate-test-confusion-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.5: Confusion matrix for the test set.
</figcaption></figure>
</div>
</div>
</div>
</div>
<p>On the test set the false instances look similar to the distribution on the training set, with the exception that learners are more likely to be falsely predicted to be natives than the other way around.</p>
<p>We can inspect the errors on the test set by filtering the data frame to only include the false instances. I will then select the columns with the actual outcome, the predicted outcome, the proficiency level, and the text and separate the predicted outcome to inspect them separately, as seen in <a href="#exm-pda-class-tune-hyperparameters-evaluate-test-errors" class="quarto-xref">Example&nbsp;<span>9.30</span></a>.</p>
<div id="exm-pda-class-tune-hyperparameters-evaluate-test-errors" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.30</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Inspect errors</span></span>
<span><span class="va">cls_lasso_fit_preds_test</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">!=</span> <span class="va">.pred_class</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">outcome</span>, <span class="va">.pred_class</span>, <span class="va">proficiency</span>, <span class="va">text</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 43 × 4
&gt;    outcome .pred_class proficiency        text                                  
&gt;    &lt;fct&gt;   &lt;fct&gt;       &lt;chr&gt;              &lt;chr&gt;                                 
&gt;  1 Learner Native      Upper beginner     "Un dia, El niño estaba durmiendo cua…
&gt;  2 Learner Native      Lower intermediate "Estoy actualmente en mi segundo año …
&gt;  3 Learner Native      Lower intermediate "La película “Solas” contiene muchos …
&gt;  4 Learner Native      Upper intermediate "Un día decidí llevarme a casa una ra…
&gt;  5 Learner Native      Lower advanced     "El año pasado nos fuimos al festivál…
&gt;  6 Learner Native      Lower advanced     "Bueno, el año pasado mi novia y yo v…
&gt;  7 Learner Native      Lower advanced     "Me parece que en actualidad, el mund…
&gt;  8 Learner Native      Lower advanced     "Acabo de visitar Barcelona con mi no…
&gt;  9 Learner Native      Lower advanced     "Podria escribir un lilbro de mis pla…
&gt; 10 Learner Native      Lower advanced     "Un día Miguel y su perro Pepe encont…
&gt; # ℹ 33 more rows</code></pre>
</div>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Inspect learners falsely predicted to be natives</span></span>
<span><span class="va">cls_lasso_fit_preds_test</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">==</span> <span class="st">"Learner"</span>, <span class="va">.pred_class</span> <span class="op">==</span> <span class="st">"Native"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">outcome</span>, <span class="va">.pred_class</span>, <span class="va">proficiency</span>, <span class="va">text</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">proficiency</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 5 × 2
&gt;   proficiency            n
&gt;   &lt;chr&gt;              &lt;int&gt;
&gt; 1 Upper advanced        13
&gt; 2 Lower advanced         8
&gt; 3 Lower intermediate     2
&gt; 4 Upper beginner         1
&gt; 5 Upper intermediate     1</code></pre>
</div>
</div>
</div>
<ul>
<li><p>Majority of misclassified learners are advanced, which could be expected as they are more similar to natives. There are some beginners that are misclassified as natives, which is interesting, and not expected. But all models are wrong, but some are useful –George Box.</p></li>
<li><p>Still an open question as to why some natives are classified as learners.</p></li>
</ul>
<p>We can inspect the estimates for the features in the model to gain some insight into what features are most important for predicting the outcomes. The <code>extract_fit_parsnip()</code> function takes a trained model specification and returns a data frame with the estimated coefficients for each feature. The code is seen in <a href="#exm-pda-class-tune-hyperparameters-evaluate-test-estimates" class="quarto-xref">Example&nbsp;<span>9.31</span></a>.</p>
<div id="exm-pda-class-tune-hyperparameters-evaluate-test-estimates" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.31</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract estimates</span></span>
<span><span class="va">cls_wf_lasso_fit</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">extract_fit_parsnip</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 1,001 × 3
&gt;    term               estimate penalty
&gt;    &lt;chr&gt;                 &lt;dbl&gt;   &lt;dbl&gt;
&gt;  1 (Intercept)         -1.37   0.00599
&gt;  2 tf_text_10           0      0.00599
&gt;  3 tf_text_2            0      0.00599
&gt;  4 tf_text_3            0      0.00599
&gt;  5 tf_text_4            0      0.00599
&gt;  6 tf_text_a            0.350  0.00599
&gt;  7 tf_text_abandonado   0.0222 0.00599
&gt;  8 tf_text_abuela       0      0.00599
&gt;  9 tf_text_abuelos      0      0.00599
&gt; 10 tf_text_aburrido    -0.108  0.00599
&gt; # ℹ 991 more rows</code></pre>
</div>
</div>
</div>
<p>The estimates are the log odds of the outcome. In a binary classification task, the log odds of the outcome is the log of the probability of the outcome divided by the probability of the other outcome. In our case, the reference outcome is “Learner”, so negative log-odds indicate that the feature is associated with the “Learner” outcome and positive log-odds indicate that the feature is associated with the “Native” outcome.</p>
<p>The estimates are in log-odds, so we need to exponentiate them to get the odds. The odds are the probability of the outcome divided by the probability of the other outcome. The probability of the outcome is the odds divided by the odds plus one. The code is seen in <a href="#exm-pda-class-tune-hyperparameters-evaluate-test-estimates-probability" class="quarto-xref">Example&nbsp;<span>9.32</span></a>.</p>
<div id="exm-pda-class-tune-hyperparameters-evaluate-test-estimates-probability" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.32</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calculate probability</span></span>
<span><span class="va">cls_wf_lasso_fit</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">extract_fit_parsnip</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>probability <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 1,001 × 4
&gt;    term               estimate penalty probability
&gt;    &lt;chr&gt;                 &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt;
&gt;  1 (Intercept)         -1.37   0.00599       0.202
&gt;  2 tf_text_10           0      0.00599       0.5  
&gt;  3 tf_text_2            0      0.00599       0.5  
&gt;  4 tf_text_3            0      0.00599       0.5  
&gt;  5 tf_text_4            0      0.00599       0.5  
&gt;  6 tf_text_a            0.350  0.00599       0.587
&gt;  7 tf_text_abandonado   0.0222 0.00599       0.506
&gt;  8 tf_text_abuela       0      0.00599       0.5  
&gt;  9 tf_text_abuelos      0      0.00599       0.5  
&gt; 10 tf_text_aburrido    -0.108  0.00599       0.473
&gt; # ℹ 991 more rows</code></pre>
</div>
</div>
</div>
<p>So just looking at the snippet of the features returned from <a href="#exm-pda-class-tune-hyperparameters-evaluate-test-estimates-probability" class="quarto-xref">Example&nbsp;<span>9.32</span></a>, we can see that the features ‘a’ and ‘abandonado’ are slightly associated with the “Native” outcome nd the other features are neutral (<code>probability</code> = 0.5).</p>
<p>A quick way to extract the most important features for predicting the each outcome is to use the <code><a href="https://koalaverse.github.io/vip/reference/vi.html">vi()</a></code> function from the <code>vip</code> package. It takes a trained model specification and returns a data frame with the most important features. The code is seen in <a href="#exm-pda-class-tune-hyperparameters-evaluate-test-vip" class="quarto-xref">Example&nbsp;<span>9.33</span></a>.</p>
<div id="exm-pda-class-tune-hyperparameters-evaluate-test-vip" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.33</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/koalaverse/vip/">vip</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">conflicted</span><span class="fu">::</span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflicts_prefer.html">conflicts_prefer</a></span><span class="op">(</span><span class="fu">vip</span><span class="fu">::</span><span class="va"><a href="https://koalaverse.github.io/vip/reference/vi.html">vi</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract important features</span></span>
<span><span class="va">var_importance_tbl</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">cls_wf_lasso_fit</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://koalaverse.github.io/vip/reference/vi.html">vi</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">var_importance_tbl</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 1,000 × 3
&gt;    Variable           Importance Sign 
&gt;    &lt;chr&gt;                   &lt;dbl&gt; &lt;chr&gt;
&gt;  1 tf_text_todavia          8.67 NEG  
&gt;  2 tf_text_eeuu             7.20 NEG  
&gt;  3 tf_text_ésta             6.31 POS  
&gt;  4 tf_text_sorpresa         6.31 POS  
&gt;  5 tf_text_sienta           6.30 POS  
&gt;  6 tf_text_arriba           6.29 NEG  
&gt;  7 tf_text_ahí              6.06 POS  
&gt;  8 tf_text_encuentran       5.86 NEG  
&gt;  9 tf_text_mayoría          5.85 NEG  
&gt; 10 tf_text_favorito         5.75 NEG  
&gt; # ℹ 990 more rows</code></pre>
</div>
</div>
</div>
<p>The <code>Variable</code> column contains each feature (with the feature type and corresponding variable <code>tf_text_</code>), <code>Importance</code> provides the absolute log-odds value, and the <code>Sign</code> column indicates whether the feature is associated with the “NEG” (“Learner”) or the “POS” (“Native”) outcome. We can recode the <code>Variable</code> and <code>Sign</code> columns to make them more interpretable and exponentiate the log-odds to get probabilites and then plot them using <code>ggplot()</code>, as in <a href="#exm-pda-class-tune-hyperparameters-evaluate-test-vip-plot" class="quarto-xref">Example&nbsp;<span>9.34</span></a>.</p>
<div id="exm-pda-class-tune-hyperparameters-evaluate-test-vip-plot" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.34</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Recode variable and sign</span></span>
<span><span class="va">var_importance_tbl</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">var_importance_tbl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    Feature <span class="op">=</span> <span class="fu">str_remove</span><span class="op">(</span><span class="va">Variable</span>, <span class="st">"tf_text_"</span><span class="op">)</span>,</span>
<span>    Outcome <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="va">Sign</span> <span class="op">==</span> <span class="st">"NEG"</span> <span class="op">~</span> <span class="st">"Learner"</span>, <span class="va">Sign</span> <span class="op">==</span> <span class="st">"POS"</span> <span class="op">~</span> <span class="st">"Native"</span><span class="op">)</span>,</span>
<span>    Importance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">Importance</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">Importance</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">Outcome</span>, <span class="va">Feature</span>, <span class="va">Importance</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="va">var_importance_tbl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">slice_max</span><span class="op">(</span><span class="va">Importance</span>, n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">Feature</span>, <span class="va">Importance</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">Importance</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">Outcome</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"Importance"</span>, fill <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pda-class-tune-hyperparameters-evaluate-test-vip-plot" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pda-class-tune-hyperparameters-evaluate-test-vip-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="prediction_files/figure-html/fig-pda-class-tune-hyperparameters-evaluate-test-vip-plot-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pda-class-tune-hyperparameters-evaluate-test-vip-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.6: Most important features for predicting the outcome.
</figcaption></figure>
</div>
</div>
</div>
</div>
<p>We can inspect <a href="#fig-pda-class-tune-hyperparameters-evaluate-test-vip-plot" class="quarto-xref">Figure&nbsp;<span>9.6</span></a>, and qualitatively assess what these features may be telling us about the differences between the learners and the natives.</p>
<!--
In a supervised text classification task, you can use parallel coordinate plots to visualize the distribution of class labels across different feature dimensions. This can help identify which features are most informative for distinguishing between classes and inform feature selection or dimensionality reduction techniques.
-->
<p>In this section we’ve build a text classifier using a regularized logistic regression model. We’ve tuned the hyperparameters to arrive at a robust model that performs well on both the training and test sets. We’ve also evaluated the model errors and inspected the most important features for predicting the outcome.</p>
<p>The <code>tidymodels</code> package provides a framework for building and evaluating supervised machine learning models that is modular in nature. This means, that we can quickly and easily change the model specification, the features, feature engineering, and the hyperparameters to arrive at a robust model. If the model is not robust, we can change models in the model specification. If the features are not robust, we can change the recipe. If the model is overfitting, we can tune the hyperparameters.</p>
</section><section id="sec-pda-text-regression" class="level3" data-number="9.2.2"><h3 data-number="9.2.2" class="anchored" data-anchor-id="sec-pda-text-regression">
<span class="header-section-number">9.2.2</span> Text regression</h3>
<p>We will now turn our attention to the second task in this section, text regression. In this task, we will use the same original dataset as in the classification task, but we will predict the placement score based on the learner writing samples. Let’s start by extracting the observations (only learners) and the relevant variables from the original data set. The code is seen in <a href="#exm-pda-reg-data" class="quarto-xref">Example&nbsp;<span>9.35</span></a>.</p>
<div id="exm-pda-reg-data" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.35</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract observations and relevant variables</span></span>
<span><span class="va">reg</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">proficiency</span> <span class="op">!=</span> <span class="st">"Native"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span><span class="op">(</span>outcome <span class="op">=</span> <span class="va">placement_score</span>, <span class="va">proficiency</span>, <span class="va">text</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">reg</span> <span class="op">|&gt;</span> <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; Rows: 1,906
&gt; Columns: 3
&gt; $ outcome     &lt;dbl&gt; 14.0, 16.3, 16.3, 18.6, 18.6, 18.6, 20.9, 20.9, 20.9, 20.9…
&gt; $ proficiency &lt;chr&gt; "Lower beginner", "Lower beginner", "Lower beginner", "Low…
&gt; $ text        &lt;chr&gt; "Yo vivo es Alanta, Georgia. Atlanta es muy grande ciudad.…</code></pre>
</div>
</div>
</div>
<!-- Step 1: Identify variables -->
<p>In this task, our outcome variable is numeric so we do not need, or want, to convert it to a factor. Our predictor variable <code>text</code> is the same as before. We have already weighed the options for feature engineering and decided to use the term frequency method (raw counts) for the top 1,000. Since we are setting up the same recipe as before, essentially, we can use the same code as before.</p>
<!-- [ ] different features? bigrams? tf-idf weighting? -->
<!-- Step 2: Initial split -->
<p>Let’s first move to step 2, initial split. We will use the <code>initial_split()</code> function again, but this time we will not need to stratify the data as we are not predicting a categorical variable. The code is seen in <a href="#exm-pda-reg-initial-split" class="quarto-xref">Example&nbsp;<span>9.36</span></a>.</p>
<div id="exm-pda-reg-initial-split" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.36</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split data</span></span>
<span><span class="va">reg_split</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">initial_split</span><span class="op">(</span><span class="va">reg</span>, prop <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Training set</span></span>
<span><span class="va">reg_train</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">training</span><span class="op">(</span><span class="va">reg_split</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Test set</span></span>
<span><span class="va">reg_test</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">testing</span><span class="op">(</span><span class="va">reg_split</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The training set has 1524 observations and the test set has 382 observations.</p>
<!-- Step 3: Integrate -->
<p>Now we can create the recipe to set up the variable relations, select the features, and engineer the features. The code is seen in <a href="#exm-pda-reg-recipe" class="quarto-xref">Example&nbsp;<span>9.37</span></a>.</p>
<div id="exm-pda-reg-recipe" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.37</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create a recipe</span></span>
<span><span class="va">reg_rec</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">text</span>, data <span class="op">=</span> <span class="va">reg_train</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tokenize.html">step_tokenize</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tokenfilter.html">step_tokenfilter</a></span><span class="op">(</span><span class="va">text</span>, max_tokens <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tf.html">step_tf</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_log.html">step_log</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span><span class="op">(</span><span class="op">)</span>, offset <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">reg_rec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<!-- Step 4: Inspect -->
<p>At this point we would inspect our recipe to make sure that it looks as expected and gauge the number of features. But since are using the same recipe as before, we can skip this step.</p>
<!-- Step 5: Interrogate -->
<p>We can now proceed to interrogate the data. As before we will want to start with a simple model and then build up to more complex models. Let’s consider some common algorithms for regression tasks in <a href="#tbl-pda-reg-algorithms" class="quarto-xref">Table&nbsp;<span>9.4</span></a>.</p>
<div id="tbl-pda-reg-algorithms" class="striped quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-pda-reg-algorithms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;9.4: Regression algorithms
</figcaption><div aria-describedby="tbl-pda-reg-algorithms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table-striped table">
<colgroup>
<col style="width: 30%">
<col style="width: 30%">
<col style="width: 38%">
</colgroup>
<thead><tr class="header">
<th>Algorithm</th>
<th>Strengths</th>
<th>Shortcomings</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Linear regression</td>
<td>Simple, interpretable, fast</td>
<td>Assumes linear relationship between features and outcome</td>
</tr>
<tr class="even">
<td>Decision trees</td>
<td>Nonlinear relationships, interpretable</td>
<td>Prone to overfitting</td>
</tr>
<tr class="odd">
<td>Random forest</td>
<td>Nonlinear relationships, interpretable</td>
<td>Prone to overfitting</td>
</tr>
<tr class="even">
<td>Neural networks</td>
<td>Nonlinear relationships, fast</td>
<td>Prone to overfitting, difficult to interpret</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<!--
[ ] Model descriptions:

Linear regression can be used to predict a numeric outcome variable from a set of features. It is a parametric method, which means that it makes assumptions about the underlying distribution of the data. It is an iterative method, which means that it uses an iterative algorithm to find the optimal parameters. To avoid overfitting it uses regularization such as ridge regression or lasso regression. These regularization methods penalize the model for having too many parameters. However, how does one know what the optimal number of parameters is? This is where cross-validation comes in.

Decision trees for text classification are a supervised machine learning method for classification. They are a non-parametric method, which means that they do not make any assumptions about the underlying distribution of the data. They are a greedy method, which means that they use a greedy algorithm to find the optimal split of the predictor variables. They are a simple method, which means that they are easy to understand and implement.

In practical terms using decision trees for text classification can be very useful as they are easy to interpret. For example, we can see which words are most important for the classification of a text. However, they are prone to overfitting the training data.

To avoid this we can use a technique called **bagging**. Bagging is a resampling technique that builds and combines multiple decision trees to make a prediction.

A **random forest** uses bagged decision trees, with the addition that each decision tree is trained on a random sample of the features. This helps to reduce the correlation between the decision trees and thus reduces the variance of the model.


Neural networks are a supervised machine learning method for regression and classification. They are a non-parametric method, which means that they do not make any assumptions about the underlying distribution of the data. They are an iterative method, which means that they use an iterative algorithm to find the optimal parameters. They are a complex method, which means that they are difficult to understand and implement. However, they are very powerful and can be used to solve a wide range of problems. However, they are expensive to train and require a lot of data. It is often the case that a simpler method will perform just as well as a neural network in certain contexts.

See https://smltar.com/mlregression.html for more info on evaluation (and other aspects) of supervised machine learning regression models.  -->
<p>Let’s start with a with a linear regression model in mind for our model specification. But let’s also consider what we learned in our first attempt to build a logistic regression model using word frequencies. We learned that the model was overfitting the training data and we needed to use a regularized model to reduce the variance of the model. So let’s start with a regularized linear regression model.</p>
<p>The <code>linear_reg()</code> function, just as the <code>logistic_reg()</code> function, provides arguments for the regularization hyperparameters when the <code>glmnet</code> computational engine is used. Let’s tune the <code>penalty</code> hyperparameter in the same way as before. The code for the process is seen in <a href="#exm-pda-reg-model-spec-tune" class="quarto-xref">Example&nbsp;<span>9.38</span></a>.</p>
<div id="exm-pda-reg-model-spec-tune" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.38</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create model specification</span></span>
<span><span class="va">reg_spec_lasso</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">linear_reg</span><span class="op">(</span>penalty <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>, mixture <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"glmnet"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create workflow</span></span>
<span><span class="va">reg_wf_lasso</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">reg_rec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">reg_spec_lasso</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create tuning grid</span></span>
<span><span class="va">reg_grid</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">grid_regular</span><span class="op">(</span><span class="fu">penalty</span><span class="op">(</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create tuning workflow</span></span>
<span><span class="va">reg_tune</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">tune_grid</span><span class="op">(</span></span>
<span>    <span class="va">reg_wf_lasso</span>,</span>
<span>    resamples <span class="op">=</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">reg_train</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    grid <span class="op">=</span> <span class="va">reg_grid</span>,</span>
<span>    control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Select best parameter</span></span>
<span><span class="va">chosen_penalty</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">reg_tune</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select_best</span><span class="op">(</span>metric <span class="op">=</span> <span class="st">"rmse"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Update workflow</span></span>
<span><span class="va">reg_final_wf_lasso</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">reg_wf_lasso</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">finalize_workflow</span><span class="op">(</span><span class="va">chosen_penalty</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg_final_wf_lasso</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; ══ Workflow ════════════════════════════════════════════════════════════════════
&gt; Preprocessor: Recipe
&gt; Model: linear_reg()
&gt; 
&gt; ── Preprocessor ────────────────────────────────────────────────────────────────
&gt; 4 Recipe Steps
&gt; 
&gt; • step_tokenize()
&gt; • step_tokenfilter()
&gt; • step_tf()
&gt; • step_log()
&gt; 
&gt; ── Model ───────────────────────────────────────────────────────────────────────
&gt; Linear Regression Model Specification (regression)
&gt; 
&gt; Main Arguments:
&gt;   penalty = 1
&gt;   mixture = 1
&gt; 
&gt; Computational engine: glmnet</code></pre>
</div>
</div>
</div>
<p>Now we fit this model to the training data and evaluate the performance using cross-validation. The code is seen in <a href="#exm-pda-reg-model-spec-tune-fit-evaluate" class="quarto-xref">Example&nbsp;<span>9.39</span></a>.</p>
<div id="exm-pda-reg-model-spec-tune-fit-evaluate" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.39</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Cross-validated workflow</span></span>
<span><span class="va">reg_cv_lasso</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">reg_final_wf_lasso</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fit_resamples</span><span class="op">(</span></span>
<span>    resamples <span class="op">=</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">reg_train</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Collect metrics</span></span>
<span><span class="va">reg_cv_lasso</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 2 × 6
&gt;   .metric .estimator   mean     n std_err .config             
&gt;   &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
&gt; 1 rmse    standard   13.3      10  0.348  Preprocessor1_Model1
&gt; 2 rsq     standard    0.659    10  0.0222 Preprocessor1_Model1</code></pre>
</div>
</div>
</div>
<p>Now, the RMSE estimate is 13.3. RMSE is expressed in the same units as the outcome variable. In this case, the outcome variable is the placement test score percent. So the RMSE is 13.3 percentage points. The <span class="math inline">\(R^2\)</span> (rsq) is 0.659. This means that the model explains 66% of the variance in the outcome variable. Taken together, this isn’t the best model.</p>
<p>But how good or bad is it? This is where we can use the null model to compare the model to. The null model is a model that predicts the mean of the outcome variable. We can use the <code>null_model()</code> function to create a null model and submit it to cross-validation. The code is seen in <a href="#exm-pda-reg-model-spec-tune-fit-evaluate-null" class="quarto-xref">Example&nbsp;<span>9.40</span></a>.</p>
<div id="exm-pda-reg-model-spec-tune-fit-evaluate-null" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.40</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create null model</span></span>
<span><span class="va">null_model</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">null_model</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"parsnip"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cross-validate null model</span></span>
<span><span class="va">null_cv</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">reg_rec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">null_model</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fit_resamples</span><span class="op">(</span></span>
<span>    resamples <span class="op">=</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">reg_train</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    metrics <span class="op">=</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">rmse</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Collect metrics</span></span>
<span><span class="va">null_cv</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 1 × 6
&gt;   .metric .estimator  mean     n std_err .config             
&gt;   &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
&gt; 1 rmse    standard    22.6    10   0.206 Preprocessor1_Model1</code></pre>
</div>
</div>
</div>
<p>Our regression model performs better than the null model (22.608) which means that it is picking up on some signal in the data.</p>
<p>Let’s visualize the distribution of the predictions and the errors from our model to see if there are any patterns of interest. We can use the <code>collect_predictions()</code> function to extract the predictions of the cross-validation and plot the true outcome against the predicted outcome using <code>ggplot()</code>, as in <a href="#exm-pda-reg-lr-eval-rmse" class="quarto-xref">Example&nbsp;<span>9.58</span></a>.</p>
<div id="exm-pda-reg-lr-eval-rmse" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.41</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Visualize predictions</span></span>
<span><span class="va">reg_cv_lasso</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_predictions</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">outcome</span>, <span class="va">.pred</span>, shape <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span>, position <span class="op">=</span> <span class="fu">position_jitter</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> <span class="co"># trend for each fold</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Truth"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Predicted score"</span>,</span>
<span>    shape <span class="op">=</span> <span class="st">"Fold"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pda-reg-lr-eval-rmse" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pda-reg-lr-eval-rmse-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="prediction_files/figure-html/fig-pda-reg-lr-eval-rmse-1.png" class="img-fluid figure-img" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pda-reg-lr-eval-rmse-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.7: Distribution of the RMSE for the cross-validated linear regression model.
</figcaption></figure>
</div>
</div>
</div>
</div>
<p>From this plot, we see data points for each predicted and truth value pair for each of the ten folds. There is a trend line for each fold which shows the linear relationship between the predicted and truth values for each fold. The trend lines are more similar than different, which is a good sign that the model is not wildly overfitting the training data. Looking closer, however, we can see the errors. Some are noticeably distant from the linear trend lines, <em>i.e.</em> outliers, in particular for test scores in the lower ranges.</p>
<p>If the <span class="math inline">\(R^2\)</span> value is in the ballpark, this means that somewhere around 40% of the variation is not explained by the frequency of the top 1,000 words. This is not surprising, as there are many other factors that contribute to the proficiency level of a text.</p>
<p>We have a model that is performing better than the null model, but it is not performing well enough to be very useful. We will need to update the model specification and/ or the features to try to improve the model fit. Let’s start with the model. There are many different model specifications we could try, but we will likely need to use a more complex model specification to capture the complexity that we observed in the errors from the previous model.</p>
<p>Let’s try a decision tree model. <strong>Decision trees</strong> are non-linear models that are able to model non-linear relationships and interactions between the features and the outcome and tend to be less influenced by outliers. These are all desirable characteristics. Decision trees, however, can be prone to overfitting</p>
<p>Along the spectrum of model complexity, decision trees are more complex than linear regression models, but less complex than other models such as neural networks. Furthermore, decision trees are interpretable, which is a nice feature for an exploratory-oriented analysis.</p>
<p>To implement a new model in <code>tidymodels</code>, we need to create a new model specification and a new workflow. We will use the <code>decision_tree()</code> function from the <code>parsnip</code> package to create the model specification. The <code>decision_tree()</code> function takes no arguments and returns a <code>decision_tree</code> object. We create the new model specification in <a href="#exm-pda-reg-model-spec-decision-tree" class="quarto-xref">Example&nbsp;<span>9.42</span></a>.</p>
<div id="exm-pda-reg-model-spec-decision-tree" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.42</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create model specification</span></span>
<span><span class="va">reg_spec_tree</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">decision_tree</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"rpart"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg_spec_tree</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; Decision Tree Model Specification (regression)
&gt; 
&gt; Computational engine: rpart</code></pre>
</div>
</div>
</div>
<p>We now have a new model specification. We can now create a new workflow. We will use the same recipe as before, but we will change the model specification to <code>prof_spec_tree</code>. We add this to a new workflow and fit the workflow to the training data. The code is seen in <a href="#exm-pda-reg-model-spec-decision-tree-workflow" class="quarto-xref">Example&nbsp;<span>9.43</span></a>.</p>
<div id="exm-pda-reg-model-spec-decision-tree-workflow" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.43</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create workflow</span></span>
<span><span class="va">reg_wf_tree</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">reg_rec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">reg_spec_tree</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cross-validated workflow</span></span>
<span><span class="va">reg_cv_tree</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">reg_wf_tree</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fit_resamples</span><span class="op">(</span></span>
<span>    resamples <span class="op">=</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">reg_train</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>We can now evaluate the performance of the model using cross-validation. The code is seen in <a href="#exm-pda-reg-model-spec-decision-tree-workflow-evaluate" class="quarto-xref">Example&nbsp;<span>9.44</span></a>.</p>
<div id="exm-pda-reg-model-spec-decision-tree-workflow-evaluate" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.44</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Collect metrics</span></span>
<span><span class="va">reg_cv_tree</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 2 × 6
&gt;   .metric .estimator   mean     n std_err .config             
&gt;   &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
&gt; 1 rmse    standard   15.1      10  0.404  Preprocessor1_Model1
&gt; 2 rsq     standard    0.554    10  0.0215 Preprocessor1_Model1</code></pre>
</div>
</div>
</div>
<p>The metrics for the vanilla decision tree are similar to the regularized linear regression model. The RSME is 15.1 and the <span class="math inline">\(R^2\)</span> is 0.554. Yet, if we compare the standard error between the two models, we can see that the decision tree model has a larger standard error. This means that the decision tree model is more prone to overfitting the training data.</p>
<p>To minimize overfitting, we can tune hyperparameters of the model. Regularization is one way to reduce overfitting, as we saw with the regularized linear regression model. Another way to reduce overfitting is to reduce the complexity of the model. This can be done by reducing the number of features or by reducing the number of splits in the decision tree, known as <strong>pruning</strong>.</p>
<p>Another approach is to implement a random forest model. A <strong>random forest</strong> is an ensemble model that combines multiple decision trees to make a prediction. A random forest is a type of ensemble model which means that it combines multiple models to make a prediction. In addition to multiple decision trees, random forests also perform random feature selection. This helps to reduce the correlation between the decision trees and thus reduces the variance of the model.</p>
<p>Let’s try a random forest model. We will use the <code>rand_forest()</code> function from the <code>parsnip</code> package to create the model specification. The <code>rand_forest()</code> function takes no arguments and returns a <code>rand_forest</code> object. We will select the <code>ranger</code> engine and add the <code>importance</code> argument to ensure that we can extract feature importance if this model proves to be useful. We create the new model specification in <a href="#exm-pda-reg-model-spec-random-forest" class="quarto-xref">Example&nbsp;<span>9.45</span></a>.</p>
<div id="exm-pda-reg-model-spec-random-forest" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.45</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create model specification</span></span>
<span><span class="va">reg_spec_rf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">rand_forest</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"ranger"</span>, importance <span class="op">=</span> <span class="st">"impurity"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg_spec_rf</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; Random Forest Model Specification (regression)
&gt; 
&gt; Engine-Specific Arguments:
&gt;   importance = impurity
&gt; 
&gt; Computational engine: ranger</code></pre>
</div>
</div>
</div>
<p>We can now update the workflow to use the new model specification. The code is seen in <a href="#exm-pda-reg-model-spec-random-forest-workflow" class="quarto-xref">Example&nbsp;<span>9.46</span></a>.</p>
<div id="exm-pda-reg-model-spec-random-forest-workflow" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.46</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Update workflow</span></span>
<span><span class="va">reg_wf_rf</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">reg_wf_tree</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">update_model</span><span class="op">(</span><span class="va">reg_spec_rf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cross-validated workflow</span></span>
<span><span class="va">reg_cv_rf</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">reg_wf_rf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fit_resamples</span><span class="op">(</span></span>
<span>    resamples <span class="op">=</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">reg_train</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>We can now evaluate the performance of the model using cross-validation. The code is seen in <a href="#exm-pda-reg-model-spec-random-forest-workflow-evaluate" class="quarto-xref">Example&nbsp;<span>9.47</span></a>.</p>
<div id="exm-pda-reg-model-spec-random-forest-workflow-evaluate" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.47</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Collect metrics</span></span>
<span><span class="va">reg_cv_rf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 2 × 6
&gt;   .metric .estimator   mean     n std_err .config             
&gt;   &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
&gt; 1 rmse    standard   13.1      10  0.305  Preprocessor1_Model1
&gt; 2 rsq     standard    0.680    10  0.0133 Preprocessor1_Model1</code></pre>
</div>
</div>
</div>
<p>The random forest model performs better than the decision tree model and the regularized linear regression model. The RSME is 13.1 and the <span class="math inline">\(R^2\)</span> is 0.68. We also see that the standard error is the lowest of the models we have tried so far. This means that the random forest model is less prone to overfitting the training data.</p>
<p>Before we settle on this model, let’s try one more model, a support vector machine (SVM). A <strong>support vector machine</strong> is a supervised machine learning model that can be used for both classification and regression. It is a non-parametric method, which means that it does not make any assumptions about the underlying distribution of the data. It is also a method which can be better suited for high-dimensional data where many values are zero, that is, sparse data, which is often the case with text data.</p>
<p>Let’s again specify the model. We will use the <code>svm_linear()</code> function from the <code>parsnip</code> package to create the model specification and we will use the <code>LiblineaR</code> computational engine. We create the new model specification in <a href="#exm-pda-reg-model-spec-svm" class="quarto-xref">Example&nbsp;<span>9.48</span></a>.</p>
<div id="exm-pda-reg-model-spec-svm" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.48</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create model specification</span></span>
<span><span class="va">reg_spec_svm</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">svm_linear</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"LiblineaR"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg_spec_svm</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; Linear Support Vector Machine Model Specification (regression)
&gt; 
&gt; Computational engine: LiblineaR</code></pre>
</div>
</div>
</div>
<p>Now let’s update the workflow to use the new model specification. The code is seen in <a href="#exm-pda-reg-model-spec-svm-workflow" class="quarto-xref">Example&nbsp;<span>9.49</span></a>.</p>
<div id="exm-pda-reg-model-spec-svm-workflow" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.49</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Update workflow</span></span>
<span><span class="va">reg_wf_svm</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">reg_wf_rf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">update_model</span><span class="op">(</span><span class="va">reg_spec_svm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cross-validated workflow</span></span>
<span><span class="va">reg_cv_svm</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">reg_wf_svm</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fit_resamples</span><span class="op">(</span></span>
<span>    resamples <span class="op">=</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">reg_train</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s evaluate the cross-validation performance of the model. The code is seen in <a href="#exm-pda-reg-model-spec-svm-workflow-evaluate" class="quarto-xref">Example&nbsp;<span>9.50</span></a>.</p>
<div id="exm-pda-reg-model-spec-svm-workflow-evaluate" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.50</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Collect metrics</span></span>
<span><span class="va">reg_cv_svm</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 2 × 6
&gt;   .metric .estimator   mean     n std_err .config             
&gt;   &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
&gt; 1 rmse    standard   14.7      10  0.353  Preprocessor1_Model1
&gt; 2 rsq     standard    0.625    10  0.0152 Preprocessor1_Model1</code></pre>
</div>
</div>
</div>
<p>This SVR is not performing better than the linear regression and random forest models and the standard error is not particularly low. So we will not pursue this model further.</p>
<p>So in summary, we’ve tried four different model specifications. The regularized linear regression model, the decision tree model, the random forest model, and the support vector machine model. The random forest model performed the best. But there stands to be improvement, but it looks as if we may need to update the features.</p>
<p>In the recipe we have used until this point we have limited the word features to 1,000 and used the raw counts of the words. The rationale for this was that we wanted to limit the number of features to reduce the complexity of the model while still capturing the most important features. But we may have limited the features too much, at least now that we are comparing features between the same population (learners). A potentially more informative feature would be the TF-IDF score. This score is a measure of how important a word is to a document in a collection or corpus. Specifically, it is the product of the term frequency and the inverse document frequency. The more dispersed a feature is across the corpus, the lower the TF-IDF score. The more concentrated a feature is across the corpus, the higher the TF-IDF score, and the more informative the feature is for distinguishing between documents.</p>
<p>So we can use the <code><a href="https://textrecipes.tidymodels.org/reference/step_tfidf.html">step_tfidf()</a></code> function to update the recipe. The code is seen in <a href="#exm-pda-reg-recipe-tfidf" class="quarto-xref">Example&nbsp;<span>9.51</span></a>.</p>
<div id="exm-pda-reg-recipe-tfidf" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.51</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create a recipe</span></span>
<span><span class="va">reg_rec</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">text</span>, data <span class="op">=</span> <span class="va">reg_train</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tokenize.html">step_tokenize</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tokenfilter.html">step_tokenfilter</a></span><span class="op">(</span><span class="va">text</span>, max_tokens <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tfidf.html">step_tfidf</a></span><span class="op">(</span><span class="va">text</span>, smooth_idf <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">reg_rec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong><i class="fa-regular fa-hand-point-up" aria-label="hand-point-up"></i> Tip</strong></p>
<p>Two things to note about the code in <a href="#exm-pda-reg-recipe-tfidf" class="quarto-xref">Example&nbsp;<span>9.51</span></a>. First, the <code><a href="https://textrecipes.tidymodels.org/reference/step_tfidf.html">step_tfidf()</a></code> function by default add a smoothing term to the inverse document frequency (IDF) calculation. This setting has the effect of reducing the influence of the IDF calculation. Thus, terms that appear in many (or all) documents will not be downweighted as much as they would be if the smoothing term was not added. For our purposes, we want to downweight or eliminate the influence of the most frequent terms, so we will set <code>smooth_idf = FALSE</code>.</p>
<p>Second, the log-transformation is not necessary when using TF-IDF scores as normalization is built into the TF-IDF calculation.</p>
</div>
</div>
</div>
<p>Another change we can explore is to increase the number of features. But how many features should we use? We can turn to the <code>tune()</code> function to help us answer this question. Let’s add the <code>tune()</code> function to the recipe and tune the <code>max_tokens</code> hyperparameter. The code is seen in <a href="#exm-pda-reg-recipe-tune" class="quarto-xref">Example&nbsp;<span>9.52</span></a>.</p>
<div id="exm-pda-reg-recipe-tune" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.52</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create a recipe</span></span>
<span><span class="va">reg_rec</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">text</span>, data <span class="op">=</span> <span class="va">reg_train</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tokenize.html">step_tokenize</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tokenfilter.html">step_tokenfilter</a></span><span class="op">(</span><span class="va">text</span>, max_tokens <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tfidf.html">step_tfidf</a></span><span class="op">(</span><span class="va">text</span>, smooth_idf <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">reg_rec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s tune the <code>max_tokens</code> with the random forest model specification that we created earlier. We will create a tuning workflow, which will tune the <code>max_tokens</code> hyperparameter on the training data using cross-validation. The code is seen in <a href="#exm-pda-reg-model-spec-random-forest-workflow-tune" class="quarto-xref">Example&nbsp;<span>9.53</span></a>.</p>
<div id="exm-pda-reg-model-spec-random-forest-workflow-tune" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.53</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create tuning workflow</span></span>
<span><span class="va">tune_wf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">reg_rec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">reg_spec_rf</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tune_wf</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; ══ Workflow ════════════════════════════════════════════════════════════════════
&gt; Preprocessor: Recipe
&gt; Model: rand_forest()
&gt; 
&gt; ── Preprocessor ────────────────────────────────────────────────────────────────
&gt; 3 Recipe Steps
&gt; 
&gt; • step_tokenize()
&gt; • step_tokenfilter()
&gt; • step_tfidf()
&gt; 
&gt; ── Model ───────────────────────────────────────────────────────────────────────
&gt; Random Forest Model Specification (regression)
&gt; 
&gt; Engine-Specific Arguments:
&gt;   importance = impurity
&gt; 
&gt; Computational engine: ranger</code></pre>
</div>
</div>
</div>
<p>The <code>tune_grid()</code> function takes a workflow, a resampling method, a tuning grid, and a set of metrics. The tuning grid is a set of hyperparameters and their values. The <code>tune_grid()</code> function will tune the hyperparameters on the training data using cross-validation. The code is seen in <a href="#exm-pda-reg-model-spec-random-forest-workflow-tune-grid" class="quarto-xref">Example&nbsp;<span>9.54</span></a>. This is a computationally intensive process, as it will train a 10 folds, for each hyperparameter value. Each fold in the random forest is 500 trees, so this will train 5,000 trees for each hyperparameter value! So that is 30,000 trees in total. This code will take some time to run.</p>
<div id="exm-pda-reg-model-spec-random-forest-workflow-tune-grid" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.54</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create tuning grid</span></span>
<span><span class="va">tune_grid</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">grid_regular</span><span class="op">(</span><span class="fu">max_tokens</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">3500</span><span class="op">)</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tune_grid</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 5 × 1
&gt;   max_tokens
&gt;        &lt;int&gt;
&gt; 1        500
&gt; 2       1250
&gt; 3       2000
&gt; 4       2750
&gt; 5       3500</code></pre>
</div>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create tuning workflow</span></span>
<span><span class="va">tune</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">tune_grid</span><span class="op">(</span></span>
<span>    <span class="va">tune_wf</span>,</span>
<span>    resamples <span class="op">=</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">reg_train</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    grid <span class="op">=</span> <span class="va">tune_grid</span>,</span>
<span>    metrics <span class="op">=</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">rmse</span>, <span class="va">rsq</span><span class="op">)</span>,</span>
<span>    control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">tune</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # Tuning results
&gt; # 10-fold cross-validation 
&gt; # A tibble: 10 × 5
&gt;    splits             id     .metrics          .notes           .predictions
&gt;    &lt;list&gt;             &lt;chr&gt;  &lt;list&gt;            &lt;list&gt;           &lt;list&gt;      
&gt;  1 &lt;split [1371/153]&gt; Fold01 &lt;tibble [10 × 5]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    
&gt;  2 &lt;split [1371/153]&gt; Fold02 &lt;tibble [10 × 5]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    
&gt;  3 &lt;split [1371/153]&gt; Fold03 &lt;tibble [10 × 5]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    
&gt;  4 &lt;split [1371/153]&gt; Fold04 &lt;tibble [10 × 5]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    
&gt;  5 &lt;split [1372/152]&gt; Fold05 &lt;tibble [10 × 5]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    
&gt;  6 &lt;split [1372/152]&gt; Fold06 &lt;tibble [10 × 5]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    
&gt;  7 &lt;split [1372/152]&gt; Fold07 &lt;tibble [10 × 5]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    
&gt;  8 &lt;split [1372/152]&gt; Fold08 &lt;tibble [10 × 5]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    
&gt;  9 &lt;split [1372/152]&gt; Fold09 &lt;tibble [10 × 5]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;    
&gt; 10 &lt;split [1372/152]&gt; Fold10 &lt;tibble [10 × 5]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble&gt;</code></pre>
</div>
</div>
</div>
<p>Just as we did for the <code>penalty</code> hyperparameter, we can visualize the performance of the model as a function of the <code>max_tokens</code> hyperparameter. The code is seen in <a href="#exm-pda-reg-model-spec-random-forest-workflow-tune-plot" class="quarto-xref">Example&nbsp;<span>9.55</span></a>.</p>
<div id="exm-pda-reg-model-spec-random-forest-workflow-tune-plot" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.55</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Visualize tuning results</span></span>
<span><span class="va">tune</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">max_tokens</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="va"><a href="https://scales.r-lib.org/reference/comma.html">comma</a></span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">.metric</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Max tokens"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pda-reg-model-spec-random-forest-workflow-tune-plot" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pda-reg-model-spec-random-forest-workflow-tune-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="prediction_files/figure-html/fig-pda-reg-model-spec-random-forest-workflow-tune-plot-1.png" class="img-fluid figure-img" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pda-reg-model-spec-random-forest-workflow-tune-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.8: Performance of the random forest model as a function of the max_tokens hyperparameter.
</figcaption></figure>
</div>
</div>
</div>
</div>
<p>We added a range of maximum token values to the tuning grid to see if there is a point of diminishing returns. We can see that the performance of the model actually appears to improve, not with more tokens, but instead with less. Our lowest value of 500 tokens appears to perform the best. This is interesting, as it suggests that there are a small number of words that are most informative for predicting the placement test score. It also suggests that individual words, on the whole, are not very informative for predicting the placement test score.</p>
<p>We can now select the best hyperparameter value. The code is seen in <a href="#exm-pda-reg-model-spec-random-forest-workflow-tune-select" class="quarto-xref">Example&nbsp;<span>9.56</span></a>.</p>
<div id="exm-pda-reg-model-spec-random-forest-workflow-tune-select" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.56</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Select best parameter</span></span>
<span><span class="va">chosen_max_tokens</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">tune</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select_best</span><span class="op">(</span>metric <span class="op">=</span> <span class="st">"rmse"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Update workflow</span></span>
<span><span class="va">reg_final_rf</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">tune_wf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">finalize_workflow</span><span class="op">(</span><span class="va">chosen_max_tokens</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg_final_rf</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; ══ Workflow ════════════════════════════════════════════════════════════════════
&gt; Preprocessor: Recipe
&gt; Model: rand_forest()
&gt; 
&gt; ── Preprocessor ────────────────────────────────────────────────────────────────
&gt; 3 Recipe Steps
&gt; 
&gt; • step_tokenize()
&gt; • step_tokenfilter()
&gt; • step_tfidf()
&gt; 
&gt; ── Model ───────────────────────────────────────────────────────────────────────
&gt; Random Forest Model Specification (regression)
&gt; 
&gt; Engine-Specific Arguments:
&gt;   importance = impurity
&gt; 
&gt; Computational engine: ranger</code></pre>
</div>
</div>
</div>
<p>We can now fit the model to the training data and evaluate the performance using cross-validation. The code is seen in <a href="#exm-pda-reg-model-spec-random-forest-workflow-tune-select-fit-evaluate" class="quarto-xref">Example&nbsp;<span>9.57</span></a>.</p>
<div id="exm-pda-reg-model-spec-random-forest-workflow-tune-select-fit-evaluate" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.57</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Cross-validated workflow</span></span>
<span><span class="va">reg_cv_rf</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">reg_final_rf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fit_resamples</span><span class="op">(</span></span>
<span>    resamples <span class="op">=</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">reg_train</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Collect metrics</span></span>
<span><span class="va">reg_cv_rf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 2 × 6
&gt;   .metric .estimator   mean     n std_err .config             
&gt;   &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
&gt; 1 rmse    standard   12.8      10  0.221  Preprocessor1_Model1
&gt; 2 rsq     standard    0.695    10  0.0137 Preprocessor1_Model1</code></pre>
</div>
</div>
</div>
<p>We’ve improved the model, but not very much. We can see that the RMSE is 13.1 and the <span class="math inline">\(R^2\)</span> is 0.68. The standard error is NA. This is the lowest standard error we have seen so far, but it is still not as low as we would like.</p>
<p>Let’s now visualize the distribution of the predictions and the errors from our word features model to see if there are any patterns of interest. We can use the <code>collect_predictions()</code> function to extract the predictions of the cross-validation and plot the true outcome agains the predicted outcome using <code>ggplot()</code>, as in <a href="#exm-pda-reg-lr-eval-rmse" class="quarto-xref">Example&nbsp;<span>9.58</span></a>.</p>
<div id="exm-pda-reg-lr-eval-rmse" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.58</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Visualize predictions</span></span>
<span><span class="va">reg_cv_rf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_predictions</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">outcome</span>, <span class="va">.pred</span>, shape <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span>, position <span class="op">=</span> <span class="fu">position_jitter</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> <span class="co"># trend for each fold</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Truth"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Predicted score"</span>,</span>
<span>    shape <span class="op">=</span> <span class="st">"Fold"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pda-reg-rf-eval-rmse" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pda-reg-rf-eval-rmse-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="prediction_files/figure-html/fig-pda-reg-rf-eval-rmse-1.png" class="img-fluid figure-img" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pda-reg-rf-eval-rmse-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.9: Distribution of the RMSE for the cross-validated linear regression model.
</figcaption></figure>
</div>
</div>
</div>
</div>
<p>There appears to be more cohesion in the predictions, overall. The errors however seem visually to be larger for the lower scores.</p>
<p>At this point we can either consider this model to be good enough or we can try to improve it further. Let’s take one more shot at improving the features by including bigrams. To include words (unigrams) and bigrams, we can modify the <code><a href="https://textrecipes.tidymodels.org/reference/step_tokenize.html">step_tokenize()</a></code> function in our recipe. We add the <code>token = "ngrams"</code> argument and specify the <code>options</code> as <code>list(n = 2, n_min = 1)</code>. This will create unigrams and bigrams. The code is seen in <a href="#exm-pda-reg-recipe-tfidf-bigrams" class="quarto-xref">Example&nbsp;<span>9.59</span></a>.</p>
<div id="exm-pda-reg-recipe-tfidf-bigrams" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.59</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create a recipe</span></span>
<span><span class="va">reg_rec</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">text</span>, data <span class="op">=</span> <span class="va">reg_train</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tokenize.html">step_tokenize</a></span><span class="op">(</span><span class="va">text</span>, token <span class="op">=</span> <span class="st">"ngrams"</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span>, n_min <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tokenfilter.html">step_tokenfilter</a></span><span class="op">(</span><span class="va">text</span>, max_tokens <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tfidf.html">step_tfidf</a></span><span class="op">(</span><span class="va">text</span>, smooth_idf <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview</span></span>
<span><span class="va">reg_rec</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Since the features have changed, we won’t assume that our tuning of the <code>max_tokens</code> is still valid. So we will tune the <code>max_tokens</code> hyperparameter again, as in <a href="#exm-pda-reg-recipe-tune" class="quarto-xref">Example&nbsp;<span>9.52</span></a> through <a href="#exm-pda-reg-model-spec-random-forest-workflow-tune-select-fit-evaluate" class="quarto-xref">Example&nbsp;<span>9.57</span></a>. For the sake of brevity, we will not show the code here. We will simply show the results.</p>
<div class="cell">
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create workflow</span></span>
<span><span class="va">reg_wf_rf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">reg_rec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">reg_spec_rf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create tuning grid</span></span>
<span><span class="va">tune_grid</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">grid_regular</span><span class="op">(</span><span class="fu">max_tokens</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">3500</span><span class="op">)</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create tuning workflow</span></span>
<span><span class="va">tune</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">tune_grid</span><span class="op">(</span></span>
<span>    <span class="va">reg_wf_rf</span>,</span>
<span>    resamples <span class="op">=</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">reg_train</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    grid <span class="op">=</span> <span class="va">tune_grid</span>,</span>
<span>    metrics <span class="op">=</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">rmse</span>, <span class="va">rsq</span><span class="op">)</span>,</span>
<span>    control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Select best parameter</span></span>
<span><span class="va">chosen_max_tokens</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">tune</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select_best</span><span class="op">(</span>metric <span class="op">=</span> <span class="st">"rmse"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Update workflow</span></span>
<span><span class="va">reg_final_rf</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">reg_wf_rf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">finalize_workflow</span><span class="op">(</span><span class="va">chosen_max_tokens</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cross-validated workflow</span></span>
<span><span class="va">reg_cv_rf</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">reg_final_rf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fit_resamples</span><span class="op">(</span></span>
<span>    resamples <span class="op">=</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">reg_train</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Collect metrics</span></span>
<span><span class="va">estimates</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">reg_cv_rf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pull</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The tuning of <code>max_tokens</code> selected 2,000 features as the optimal number. The cross-validation of the training dataset produced an RMSE of 12.8 and an <span class="math inline">\(R^2\)</span> of 0.698. The standard error is NA. The upshot is that by including bigrams we have not improved, or worsened, the model. Including the unigrams and bigrams together may be more informative for the exploration of the features.</p>
<p>We could continue to try to improve the model, but at this point we have a model that is performing better than the null model and is performing better than the other models we have tried. So we will consider this model to be good enough.</p>
<p>Let’s now fit the 1-2 gram model to the testing data and evaluate the performance on the testing set. The code is seen in <a href="#exm-pda-reg-model-spec-random-forest-workflow-tune-select-fit-evaluate-test" class="quarto-xref">Example&nbsp;<span>9.60</span></a>.</p>
<!-- Step 7: Interpret -->
<div id="exm-pda-reg-model-spec-random-forest-workflow-tune-select-fit-evaluate-test" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.60</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Fit model on training data</span></span>
<span><span class="va">reg_final_rf_fit</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">reg_final_rf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fit</span><span class="op">(</span><span class="va">reg_train</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Predict on testing data</span></span>
<span><span class="va">reg_final_rf_pred</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">bind_cols</span><span class="op">(</span></span>
<span>    <span class="va">reg_test</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">reg_final_rf_fit</span>, <span class="va">reg_test</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Evaluate performance</span></span>
<span><span class="va">reg_final_rf_pred</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">metrics</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">outcome</span>, estimate <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt; # A tibble: 3 × 3
&gt;   .metric .estimator .estimate
&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
&gt; 1 rmse    standard      12.9  
&gt; 2 rsq     standard       0.695
&gt; 3 mae     standard       9.84</code></pre>
</div>
</div>
</div>
<p>We can now visualize the feature importance of the model. The code is seen in <a href="#exm-pda-reg-model-spec-random-forest-workflow-tune-select-fit-evaluate-test-feature-importance" class="quarto-xref">Example&nbsp;<span>9.61</span></a>.</p>
<div id="exm-pda-reg-model-spec-random-forest-workflow-tune-select-fit-evaluate-test-feature-importance" class="theorem example">
<p><span class="theorem-title"><strong>Example 9.61</strong></span> &nbsp;</p>
<div class="cell">
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract predictions</span></span>
<span><span class="va">reg_final_rf_fit</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">vip</span><span class="fu">::</span><span class="fu"><a href="https://koalaverse.github.io/vip/reference/vi.html">vi</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Variable <span class="op">=</span> <span class="fu">str_replace</span><span class="op">(</span><span class="va">Variable</span>, <span class="st">"^tfidf_text_"</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">slice_max</span><span class="op">(</span><span class="va">Importance</span>, n <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># reorder variables by importance</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">Variable</span>, <span class="va">Importance</span><span class="op">)</span>, <span class="va">Importance</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Feature"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Importance"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pda-reg-model-spec-random-forest-workflow-tune-select-fit-evaluate-test-feature-importance" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pda-reg-model-spec-random-forest-workflow-tune-select-fit-evaluate-test-feature-importance-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="prediction_files/figure-html/fig-pda-reg-model-spec-random-forest-workflow-tune-select-fit-evaluate-test-feature-importance-1.png" class="img-fluid figure-img" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pda-reg-model-spec-random-forest-workflow-tune-select-fit-evaluate-test-feature-importance-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9.10: Feature importance of the random forest model.
</figcaption></figure>
</div>
</div>
</div>
</div>
</section></section><section id="activities" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="activities">Activities</h2>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong><i class="fa-regular fa-file-code" aria-label="file-code"></i> Recipe</strong></p>
<!-- Understand, apply, and analyze verbs: https://tips.uark.edu/blooms-taxonomy-verb-chart/ -->
<p><strong>What</strong>: <a href="https://qtalr.github.io/qtalrkit/articles/recipe-9.html">Building predictive models</a><br><strong>How</strong>: Read Recipe 9 and participate in the Hypothes.is online social annotation.<br><strong>Why</strong>: <i class="fa-solid fa-wrench" aria-label="wrench"></i> …</p>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong><i class="fa-solid fa-flask" aria-label="flask"></i> Lab</strong></p>
<!-- Analyze, evaluate, and create verbs: https://tips.uark.edu/blooms-taxonomy-verb-chart/ -->
<p><strong>What</strong>: <a href="https://github.com/qtalr/lab-09">Text classification</a><br><strong>How</strong>: Clone, fork, and complete the steps in Lab 9.<br><strong>Why</strong>: <i class="fa-solid fa-wrench" aria-label="wrench"></i> …</p>
</div>
</div>
</div>
</section><section id="summary" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="summary">Summary</h2>
<p>In this chapter we have learned about supervised machine learning. We have learned about the different types of supervised machine learning methods and how they can be used to predict and classify. We have also learned about the different types of data structures that are used in supervised machine learning. Finally, we have learned about the different types of evaluation metrics that are used to evaluate the performance of supervised machine learning models.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Baayen2011" class="csl-entry" role="listitem">
Baayen, R. Harald. 2011. <span>“Corpus Linguistics and Naive Discriminative Learning.”</span> <em>Revista Brasileira de Lingu<span>\</span>’<span>\</span>istica Aplicada</em> 11 (2): 295–328.
</div>
<div id="ref-Deshors2016" class="csl-entry" role="listitem">
Deshors, Sandra C, and Stefan Th. Gries. 2016. <span>“Profiling Verb Complementation Constructions Across New Englishes.”</span> <em>International Journal of Corpus Linguistics.</em> 21 (2): 192–218.
</div>
<div id="ref-Gries2014" class="csl-entry" role="listitem">
Gries, Stefan Th., and Sandra C. Deshors. 2014. <span>“Using Regressions to Explore Deviations Between Corpus Data and a Standard/Target: Two Suggestions.”</span> <em>Corpora</em> 9 (1): 109–36. <a href="https://doi.org/10.3366/cor.2014.0053">https://doi.org/10.3366/cor.2014.0053</a>.
</div>
<div id="ref-R-washoku" class="csl-entry" role="listitem">
Uryu, Shinya. 2024. <em>Washoku: Extra ’Recipes’ for Japanese Text, Date and Address Processing</em>.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>See <a href="data.html#sec-data-cabnc" class="quarto-xref">Appendix&nbsp;<span>A.3</span></a> for more information on the CEDEL2 corpus.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Note that functions for meta-features require more sophisticated text analysis software to be installed on the computing environment (e.g.&nbsp;<code>spacyr</code> for <code><a href="https://textrecipes.tidymodels.org/reference/step_lemma.html">step_lemma()</a></code>, <code>step_pos()</code>, <em>etc.</em>). See the <code>textrecipes</code> package documentation for more information.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>The LASSO (least absolute shrinkage and selection operator) is a type of regularization that penalizes the absolute value of the coefficients. In essence, it smooths the coefficients by shrinking them towards zero to avoid coefficients picking up on particularities of the training data that will not generalize to new data.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./exploration.html" class="pagination-link" aria-label="Explore">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Explore</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./inference.html" class="pagination-link" aria-label="Infer">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Infer</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/qtalr/book/blob/main/prediction.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/qtalr/book/edit/main/prediction.qmd" target="_blank" class="toc-action"><i class="bi empty"></i>Edit this page</a></li><li><a href="https://github.com/qtalr/book/issues" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>